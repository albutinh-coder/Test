<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงุฎุชุจุงุฑ ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุชูุงุนูู</title>

    <link rel="icon" href="icon.jpg" type="image/jpeg">
    <link rel="apple-touch-icon" href="icon.jpg">

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">

    
    <!-- ููุชุจุงุช JavaScript -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <!-- ุฃููููุงุช Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- ูููุงุช CSS ุงูุฎุงุตุฉ ุจุงูุชุทุจูู -->
    <link rel="stylesheet" href="css/styles.css">
    
    
    

    
    <!-- ููู ูุฏูุฑ ุงูุจุญุซ -->
<script src="js/search-manager.js"></script>


<!-- ููู ุณุฌู ุงููุดุงุท -->
<script src="js/activity-logger.js"></script>


<!-- ูุฏูุฑ ุงููุตุงุฏูุฉ ูุงููุณุชุฎุฏููู -->
<script src="js/auth-manager.js"></script>

<!-- ุงูุชุตุฏูุฑ ูุงูุงุณุชูุฑุงุฏ -->
<script src="js/export-import.js"></script>

    
    

    
  


    <script>
       // ==========================================
// ุชููุฆุฉ Firebase
// ==========================================
const firebaseConfig = {


ย apiKey: "AIzaSyAH6cct4rovMHDVALar_YyF6cU4vwXf6tY",


ย authDomain: "myliberal-2608d.firebaseapp.com",


ย databaseURL: "https://myliberal-2608d-default-rtdb.firebaseio.com",


ย projectId: "myliberal-2608d",


ย storageBucket: "myliberal-2608d.firebasestorage.app",


ย messagingSenderId: "46614298186",


ย appId: "1:46614298186:web:92a7fb83bc9a167ff0b0b3",


ย measurementId: "G-9LXJL4EK14"


};

// ุชููุฆุฉ Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();


 

  



// ูุณุงุฑุงุช Firebase
const PUBLIC_QUESTIONS_PATH = 'public/questions';
const USERS_PATH = 'users';
const APP_SETTINGS_PATH = 'public/settings';

tailwind.config = {
    darkMode: 'class',
    theme: {
        extend: {
            colors: {
                primary: '#1e40af',
                secondary: '#3b82f6',
                qaBlue: '#2563eb',
                favorite: '#f59e0b',
            },
            fontFamily: {
                sans: ['Cairo', 'sans-serif'],
            }
        }
    }
};
    </script>
    
     
</head>
<body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-white min-h-screen pb-40">
    <!-- ุญุงููุฉ ุงูุฅุดุนุงุฑุงุช -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- ูุงูุฐุฉ ุชุณุฌูู ุงูุฏุฎูู -->
    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">ุชุณุฌูู ุงูุฏุฎูู</h2>
                <p class="text-gray-600 dark:text-gray-400">ุณุฌู ุฏุฎููู ูุญูุธ ุชูุฏูู ุนูู ุฌููุน ุงูุฃุฌูุฒุฉ</p>
            </div>
            
            <div id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                    <input type="email" id="loginEmail" 
                           class="form-input"
                           placeholder="example@email.com">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="loginPassword" 
                           class="form-input"
                           placeholder="********">
                </div>
                
                <button id="submitLogin" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors">
                    ุชุณุฌูู ุงูุฏุฎูู
                </button>
                
                <div class="text-center">
                    <button id="signupToggle" class="text-blue-600 dark:text-blue-400 hover:underline text-sm">
                        ููุณ ูุฏูู ุญุณุงุจุ ุณุฌู ุงูุขู
                    </button>
                </div>
            </div>
            
            <div id="signupForm" class="space-y-4 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ุงูุงุณู ุงููุงูู</label>
                    <input type="text" id="signupName" 
                           class="form-input"
                           placeholder="ูุญูุฏ ุฃุญูุฏ">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                    <input type="email" id="signupEmail" 
                           class="form-input"
                           placeholder="example@email.com">
                    <div id="emailValidation" class="validation-message"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="signupPassword" 
                           class="form-input"
                           placeholder="********">
                    <div id="passwordStrength" class="password-strength"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="signupConfirmPassword" 
                           class="form-input"
                           placeholder="********">
                    <div id="passwordMatch" class="validation-message"></div>
                </div>
                
                <button id="submitSignup" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-colors">
                    ุฅูุดุงุก ุญุณุงุจ
                </button>
                
                <div class="text-center">
                    <button id="loginToggle" class="text-blue-600 dark:text-blue-400 hover:underline text-sm">
                        ูุฏูู ุญุณุงุจ ุจุงููุนูุ ุณุฌู ุฏุฎูู
                    </button>
                </div>
            </div>
            
            <div id="loginMessage" class="mt-4 text-center text-sm hidden"></div>
            
            <div class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button id="closeLoginModal" class="w-full py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                    ุฅูุบุงุก
                </button>
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุฅุฏุงุฑุฉ ุงููุญุชูู -->
    <div id="contentManagementModal" class="modal-overlay">
        <div class="modal-content">
            <div class="text-center mb-6">
                <h2 id="contentModalTitle" class="text-2xl font-bold text-gray-900 dark:text-white mb-2">ุฅุฏุงุฑุฉ ุงููุญุชูู</h2>
                <p id="contentModalSubtitle" class="text-gray-600 dark:text-gray-400">ุฅุถุงูุฉ/ุชุนุฏูู/ุญุฐู ุงูุฃุณุฆูุฉ</p>
            </div>
            
            <div id="contentFormContainer" class="space-y-4">
                <!-- ุณูุชู ููุก ุงููููุฐุฌ ุฏููุงููููุงู ุญุณุจ ููุน ุงูุณุคุงู -->
            </div>
            
            <div id="contentModalMessage" class="mt-4 text-center text-sm hidden"></div>
            
            <div id="contentModalFooter" class="mt-6 pt-4 border-t border-gray-200 dark:border-gray-700 flex gap-3">
                <!-- ุณูุชู ููุก ุงูุฃุฒุฑุงุฑ ุฏููุงููููุงู -->
            </div>
        </div>
    </div>

    <!-- ูุงูุฐุฉ ุฅุถุงูุฉ/ุชุนุฏูู ูุณุชุฎุฏู -->
    <div id="userEditModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="userModalTitle" class="text-2xl font-bold text-gray-900 dark:text-white">ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ</h2>
                <button onclick="hideUserEditModal()" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div id="userError" class="hidden bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 p-4 rounded-lg mb-4"></div>

            <div id="userForm" class="space-y-4">
                <input type="hidden" id="editUserId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ุงูุงุณู ุงููุงูู</label>
                    <input type="text" id="userName" class="form-input" placeholder="ูุญูุฏ ุฃุญูุฏ" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
                    <input type="email" id="userEmail" class="form-input" placeholder="example@email.com" required>
                    <div id="userEmailValidation" class="validation-message"></div>
                </div>
                
                <div id="passwordSection">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="userPassword" class="form-input" placeholder="********">
                    <div id="userPasswordStrength" class="password-strength mt-1"></div>
                </div>
                
                <div id="confirmPasswordSection">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ</label>
                    <input type="password" id="userConfirmPassword" class="form-input" placeholder="********">
                    <div id="userPasswordMatch" class="validation-message"></div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">ุงูุตูุงุญูุฉ</label>
                    <div class="flex flex-wrap gap-2 mt-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="userRole" value="student" class="sr-only peer">
                            <div class="flex items-center gap-2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-purple-500 peer-checked:bg-purple-50 dark:peer-checked:bg-purple-900/30 transition-all">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-violet-600 flex items-center justify-center text-white text-sm">
                                    <i class="fas fa-user-graduate"></i>
                                </div>
                                <span class="text-sm">ุทุงูุจ</span>
                            </div>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="userRole" value="editor" class="sr-only peer">
                            <div class="flex items-center gap-2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-green-500 peer-checked:bg-green-50 dark:peer-checked:bg-green-900/30 transition-all">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white text-sm">
                                    <i class="fas fa-pen-nib"></i>
                                </div>
                                <span class="text-sm">ูุญุฑุฑ ูุญุชูู</span>
                            </div>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="userRole" value="admin" class="sr-only peer">
                            <div class="flex items-center gap-2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/30 transition-all">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white text-sm">
                                    <i class="fas fa-user-shield"></i>
                                </div>
                                <span class="text-sm">ูุฏูุฑ ูุธุงู</span>
                            </div>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="userRole" value="super_admin" class="sr-only peer">
                            <div class="flex items-center gap-2 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg peer-checked:border-yellow-500 peer-checked:bg-yellow-50 dark:peer-checked:bg-yellow-900/30 transition-all">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-yellow-500 to-amber-600 flex items-center justify-center text-white text-sm">
                                    <i class="fas fa-crown"></i>
                                </div>
                                <span class="text-sm">ูุฏูุฑ ุฑุฆูุณู</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="userActive" class="w-4 h-4" checked>
                    <label for="userActive" class="text-sm text-gray-700 dark:text-gray-300">ุงูุญุณุงุจ ูุดุท</label>
                </div>

                <div class="flex gap-3 pt-4">
                    <button id="saveUserBtn" onclick="saveUser()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors">
                        ุญูุธ
                    </button>
                    <button onclick="hideUserEditModal()" class="flex-1 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition-colors">
                        ุฅูุบุงุก
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ุงูุดุฑูุท ุงูุนููู ุงูุซุงุจุช ุงููุดุชุฑู -->
    <nav id="fixedTopBar" class="fixed top-0 left-0 right-0 z-50 bg-white/98 dark:bg-gray-900/98 backdrop-blur-md border-b border-gray-200 dark:border-gray-800 shadow-sm transition-all duration-300 hidden">
        <div class="max-w-5xl mx-auto px-4 py-2 md:py-3">
            <div class="flex items-center justify-between gap-4">
                
                <div id="unitInfoContainer" class="flex items-center gap-3 flex-1 min-w-0">
                    <button id="backToUnitsTop" class="p-2 md:p-2.5 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-400 rounded-xl hover:bg-emerald-50 dark:hover:bg-emerald-900/30 hover:text-emerald-600 transition-all flex-shrink-0 group" title="ุงูุนูุฏุฉ">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 md:w-5 h-5 transform group-hover:-translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                    
                    <div class="flex-1 min-w-0">
                        <h1 id="unitTitleTop" class="text-xs md:text-lg font-bold text-gray-900 dark:text-gray-100 truncate leading-tight">
                            ุฌุงุฑู ุงูุชุญููู...
                        </h1>
                        <div id="unitProgressTop" class="text-[10px] md:text-sm font-black text-emerald-600 dark:text-emerald-400 truncate">
                            0%
                        </div>
                    </div>
                </div>

                <!-- ุญุงููุฉ ุงูุจุญุซ ุงูููุญุฏุฉ -->
                <div id="searchContainer" class="hidden search-container flex-1 mx-2 transition-all duration-300">
                    <div class="relative w-full">
                        <input type="text" id="smartSearchInput" placeholder="ุงุจุญุซ ..." 
                               class="w-full pr-9 pl-8 py-2 text-xs border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-transparent placeholder:text-gray-400">
                        
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2">
                            <i class="fas fa-search text-gray-400 text-xs"></i>
                        </div>

                        <button id="clearSearchBtn" class="absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                    <div id="searchResultsInfo" class="search-results-info mt-1 text-center hidden text-[10px]"></div>
                </div>

                <div class="flex items-center gap-2 flex-shrink-0">
                    
                    <div class="relative">
                        <button id="menuButton" class="group flex items-center gap-2 px-3 md:px-5 py-2.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl transition-all shadow-lg active:scale-95">
                            <span class="text-xs md:text-sm font-bold">ุงูุฃุฏูุงุช</span>
                            <svg class="w-4 h-4 transition-transform group-aria-expanded:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>

                        <div id="dropdownMenu" class="hidden absolute left-0 mt-3 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-2xl z-[100] overflow-hidden">
                            <div class="p-1.5 max-h-[75vh] overflow-y-auto">
                                <div id="firebaseStatus" class="px-4 py-2 text-xs text-center text-gray-500 dark:text-gray-400 hidden">
                                    <i class="fas fa-cloud ml-1"></i> <span id="syncStatus">ุบูุฑ ูุชุตู</span>
                                </div>
                                
                                <button id="toggleSearchBtn" class="w-full flex items-center gap-3 px-4 py-3 text-right text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-xl transition-colors">
                                    <div class="p-1.5 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600">
                                        <i class="fas fa-search w-4 h-4"></i>
                                    </div>
                                    <span id="searchToggleText">ุชูุนูู ุงูุจุญุซ ุงูุฐูู</span>
                                </button>
                                
                                <button id="toggleFavoritesSmartDropdown" class="w-full flex items-center gap-3 px-4 py-3 text-right text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-xl transition-colors">
                                    <div id="favoritesIconContainer" class="p-1.5 rounded-lg bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600">
                                        <i class="fas fa-star w-4 h-4"></i>
                                    </div>
                                    <span id="favoritesToggleText">ุนุฑุถ ุงูุฃุณุฆูุฉ ุงูููุถูุฉ</span>
                                </button>
                                
                                <button id="toggleSolutionsBtn" class="w-full flex items-center gap-3 px-4 py-3 text-right text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-xl transition-colors">
                                    <div id="solutionIconContainer" class="p-1.5 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600">
                                        <svg id="solutionIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                        </svg>
                                    </div>
                                    <span id="solutionsTextInProgress">ุฅุธูุงุฑ ุงูุญููู</span>
                                </button>
                                
                                <button id="themeToggleDropdown" class="w-full flex items-center gap-3 px-4 py-3 text-right text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-xl transition-colors">
                                    <div class="p-1.5 rounded-lg bg-amber-100 dark:bg-amber-900/30 text-amber-600">
                                        <svg id="dropdownThemeIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
                                    </div>
                                    <span>ุชุจุฏูู ุงููุธูุฑ</span>
                                </button>
                                
                                <div class="h-px bg-gray-100 dark:bg-gray-700 my-1"></div>
                                
                                <button id="printQuestionsBtn" class="w-full flex items-center gap-3 px-4 py-3 text-right text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-xl transition-colors">
                                    <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zM9 1v4h6V1" />
                                    </svg>
                                    <span>ุชุญููู PDF / ุทุจุงุนุฉ</span>
                                </button>
                                
                                <button id="resetUnitTop" class="w-full flex items-center gap-3 px-4 py-3 text-right text-sm text-red-600 hover:bg-red-50 dark:hover:bg-red-900/40 rounded-xl transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                                        <path d="M3 3v5h5" />
                                        <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16" />
                                        <path d="M16 16h5v5" />
                                    </svg>
                                    <span>ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="absolute bottom-0 left-0 w-full h-[6px] bg-gray-200/50 dark:bg-gray-800/50 overflow-hidden">
            <div id="progressFillTop" class="h-full relative" style="width: 0%; background: linear-gradient(90deg, #10b981, #34d399);">
                <div class="shimmer-effect"></div>
            </div>
        </div>
    </nav>

    <!-- ุงูููุฏุฑ ุงูุฑุฆูุณู -->
    <header id="mainHeader" class="relative bg-gradient-to-r from-blue-800 to-blue-700 text-white shadow-sm border-b border-blue-700">
        <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-center relative z-10 w-full">

            <!-- ูุณู ุงููุณุชุฎุฏู -->
            <div id="headerUserSection" class="absolute left-4 top-1/2 -translate-y-1/2 z-50">
                <div id="headerUserInfo" class="hidden">
                    <div class="relative">
                        <div id="headerUserAvatar" class="user-avatar cursor-pointer" title="ุงูุญุณุงุจ">
                            <div id="headerAvatarIcon" class="w-full h-full flex items-center justify-center"></div>
                        </div>
                        <div id="headerUserDropdown" class="user-dropdown">
                            <div class="p-3 border-b border-gray-100 dark:border-gray-700">
                                <div class="flex items-center gap-3">
                                    <div id="headerUserIcon" class="flex-shrink-0"></div>
                                    <div class="flex-1 min-w-0">
                                        <div id="headerUserName" class="font-bold text-gray-900 dark:text-white truncate"></div>
                                        <div id="headerUserEmail" class="text-xs text-gray-500 dark:text-gray-400 truncate mt-1"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-1">
                                <div id="headerAdminDropdown" class="hidden">
                                    <a href="#" class="dropdown-item" onclick="showUsersManagement()">
                                        <i class="fas fa-users text-blue-500"></i>
                                        <span>ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</span>
                                    </a>
                                    
                                    <a href="#" class="dropdown-item" onclick="showActivityLogView()">
                                        <i class="fas fa-history text-purple-500"></i>
                                        <span>ุณุฌู ุงููุดุงุท</span>
                                    </a>
                                </div>
                                <a href="#" class="dropdown-item" onclick="showBackupManagement()">
                                    <i class="fas fa-database text-purple-500"></i>
                                    <span>ุงููุณุฎ ุงูุงุญุชูุงุทู</span>
                                </a>
                                
                                <a href="#" class="dropdown-item" onclick="handleLogout()">
                                    <i class="fas fa-sign-out-alt text-red-500"></i>
                                    <span>ุชุณุฌูู ุงูุฎุฑูุฌ</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ุฒุฑ ุชุณุฌูู ุงูุฏุฎูู -->
                <button id="headerLoginBtn" onclick="showLoginModal()" class="w-10 h-10 rounded-full flex items-center justify-center shadow-md transition-all duration-300 hover:scale-110 active:scale-90 bg-gradient-to-r from-blue-500 to-indigo-600 text-white hover:from-blue-600 hover:to-indigo-700">
                    <i class="fas fa-sign-in-alt"></i>
                </button>
            </div>

            <!-- ุงูุนููุงู -->
            <a href="https://m-u-b.netlify.app/" target="_blank"
   class="flex flex-col items-center text-center gap-1 group select-none mx-auto cursor-pointer">

    <h1 class="text-sm sm:text-base font-semibold tracking-tight leading-snug
               transition-colors duration-300 group-hover:text-yellow-300 px-4">
        ุงุฎุชุจุงุฑ ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงูุชูุงุนูู
    </h1>

    <div class="w-14 h-0.5 bg-yellow-400/50 rounded-full mt-1
                transition-all duration-300 group-hover:w-20 group-hover:bg-yellow-400">
    </div>
</a>


            <!-- ุฒุฑ ุงููุถุน ุงููููู -->
            <button id="themeToggle"
                    aria-label="ุชุจุฏูู ุงููุถุน ุงููููู"
                    class="absolute right-4 top-1/2 -translate-y-1/2 w-10 h-10 flex items-center justify-center rounded-full bg-white/10 hover:bg-white/20 active:scale-90 transition-all duration-300 border border-white/20">
                <svg id="themeIcon"
                     class="w-5 h-5 text-yellow-300 transition-transform duration-500 hover:rotate-12"
                     fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
            </button>

        </div>
    </header>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <main class="container mx-auto px-4 py-8 content-padding-top">
        <!-- ุตูุญุฉ ุงููุญุฏุงุช ุงูุฑุฆูุณูุฉ -->
        <div id="unitsView" class="space-y-6">
            <div class="text-center">
                <h2 class="text-2xl font-bold mb-4">ุฃููุงู ูุณููุงู ุจู</h2>
                <p class="text-gray-600 dark:text-gray-400">ุงุฎุชุฑ ุงููุณู ุงูุฐู ุชุฑูุฏ ุงุฎุชุจุงุฑ ูุนูููุงุชู ููู</p>
            </div>
            
            <div id="unitsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 mt-8">
                <h3 class="text-lg font-semibold mb-4">ุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div><div class="text-2xl font-bold text-primary" id="totalQuestions">0</div><div class="text-sm text-gray-600 dark:text-gray-400">ุฅุฌูุงูู ุงูุฃุณุฆูุฉ</div></div>
                    <div><div class="text-2xl font-bold text-green-600 dark:text-green-400" id="correctAnswers">0</div><div class="text-sm text-gray-600 dark:text-gray-400">ุฅุฌุงุจุงุช ุตุญูุญุฉ</div></div>
                    <div><div class="text-2xl font-bold text-red-600 dark:text-red-400" id="incorrectAnswers">0</div><div class="text-sm text-gray-600 dark:text-gray-400">ุฅุฌุงุจุงุช ุฎุงุทุฆุฉ</div></div>
                    <div><div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="successRate">0%</div><div class="text-sm text-gray-600 dark:text-gray-400">ูุณุจุฉ ุงููุฌุงุญ</div></div>
                </div>
                <div class="mt-4 flex gap-2 justify-center">
                    <button id="syncAllBtn" class="px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-2 hidden">
                        <i class="fas fa-cloud-upload-alt"></i>
                        ูุฒุงููุฉ ุชูุฏูู
                    </button>
                    <button id="resetAllBtn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-white">ุฅุนุงุฏุฉ ุถุจุท ุงููู</button>
                </div>
            </div>
        </div>

        <!-- ุตูุญุฉ ุงูุฃุณุฆูุฉ -->
        <div id="questionsView" class="hidden">
            <div id="questionsList" class="space-y-6"></div>
        </div>

        <!-- ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุญุชูู -->
        <div id="contentManagementView" class="hidden">
            <!-- ุฒุฑ ุฅุถุงูุฉ ุณุคุงู ุฌุฏูุฏ -->
            <button id="addNewQuestionBtn" class="fixed bottom-6 left-6 w-14 h-14 bg-green-600 text-white rounded-full shadow-lg flex justify-center items-center text-2xl">
                <i class="fas fa-plus"></i>
            </button>

            <!-- ุนุฏุงุฏ ุงูุฃุณุฆูุฉ -->
            <div id="contentStats" class="questions-counter mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800 hidden">
                <div class="flex items-center justify-between">
                    <span class="font-bold text-blue-700 dark:text-blue-300">
                        <i class="fas fa-list-ol ml-2"></i>
                        ุฅุฌูุงูู ุงูุฃุณุฆูุฉ: <span id="totalQuestionsCount">0</span>
                    </span>
                    <span class="text-sm text-blue-600 dark:text-blue-400">
                        ุขุฎุฑ ุชุญุฏูุซ: <span id="lastUpdateTime">ุงูุขู</span>
                    </span>
                </div>
            </div>

            <div id="contentList" class="space-y-6"></div>
        </div>

        <!-- ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู  -->
        <div id="usersManagementView" class="hidden">
            <div class="max-w-5xl mx-auto">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                    <div class="bg-white dark:bg-gray-800 rounded-md shadow-sm p-3">
                        <div class="text-xl font-bold text-blue-600" id="totalUsersCount">0</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">ุฅุฌูุงูู ุงููุณุชุฎุฏููู</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-md shadow-sm p-3">
                        <div class="text-xl font-bold text-green-600" id="activeUsersCount">0</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">ูุณุชุฎุฏููู ูุดุทูู</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-md shadow-sm p-3">
                        <div class="text-xl font-bold text-purple-600" id="adminUsersCount">0</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">ูุฏูุฑูู</div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-md shadow-sm p-3">
                        <div class="text-xl font-bold text-yellow-600" id="studentUsersCount">0</div>
                        <div class="text-xs text-gray-600 dark:text-gray-400">ุทูุงุจ</div>
                    </div>
                </div>

                <!-- ุดุฑูุท ุงูุชุตููุฉ -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex gap-2">
                            <select id="roleFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                <option value="all">ุฌููุน ุงูุตูุงุญูุงุช</option>
                                <option value="super_admin">ูุฏูุฑ ุฑุฆูุณู</option>
                                <option value="admin">ูุฏูุฑ ูุธุงู</option>
                                <option value="editor">ูุญุฑุฑ ูุญุชูู</option>
                                <option value="student">ุทุงูุจ</option>
                            </select>
                            <select id="statusFilter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700">
                                <option value="all">ุฌููุน ุงูุญุงูุงุช</option>
                                <option value="active">ูุดุท ููุท</option>
                                <option value="inactive">ูุนุทู ููุท</option>
                            </select>
                        </div>
                        <div class="flex-1"></div>
                        <button onclick="showAddUserModal()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg flex items-center gap-2">
                            <i class="fas fa-user-plus"></i>
                            ุฅุถุงูุฉ ูุณุชุฎุฏู ุฌุฏูุฏ
                        </button>
                    </div>
                </div>

                <!-- ุฌุฏูู ุงููุณุชุฎุฏููู -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-right font-semibold text-gray-700 dark:text-gray-300">ุงููุณุชุฎุฏู</th>
                                    <th class="px-6 py-3 text-right font-semibold text-gray-700 dark:text-gray-300">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</th>
                                    <th class="px-6 py-3 text-right font-semibold text-gray-700 dark:text-gray-300">ุงูุญุงูุฉ</th>
                                    <th class="px-6 py-3 text-right font-semibold text-gray-700 dark:text-gray-300">ุขุฎุฑ ุฏุฎูู</th>
                                    <th class="px-6 py-3 text-right font-semibold text-gray-700 dark:text-gray-300">ุงูุฅุฌุฑุงุกุงุช</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="divide-y divide-gray-200 dark:divide-gray-700">
                                <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- ุฑุณุงูุฉ ุนูุฏูุง ูุง ููุฌุฏ ูุณุชุฎุฏููู -->
                    <div id="noUsersMessage" class="hidden text-center py-8">
                        <div class="text-4xl mb-4">๐ฅ</div>
                        <h3 class="text-xl font-bold mb-2">ูุง ููุฌุฏ ูุณุชุฎุฏููู</h3>
                        <p class="text-gray-600 dark:text-gray-400 mb-4">ูู ูุชู ุฅุถุงูุฉ ุฃู ูุณุชุฎุฏููู ุจุนุฏ</p>
                        <button onclick="showAddUserModal()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                            ุฅุถุงูุฉ ุฃูู ูุณุชุฎุฏู
                        </button>
                    </div>
                    
                    <!-- ุญุงูุฉ ุงูุชุญููู -->
                    <div id="loadingUsers" class="text-center py-8">
                        <div class="loading-spinner inline-block"></div>
                        <p class="mt-2 text-gray-600 dark:text-gray-400">ุฌุงุฑู ุชุญููู ุงููุณุชุฎุฏููู...</p>
                    </div>
                </div>
            </div>
        </div>
        
       
<!-- ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู -->
<div id="backupManagementView" class="hidden">
    <div class="max-w-5xl mx-auto p-6">
        <!-- ูุณู ุงูุชุตุฏูุฑ -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 mb-8">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-download ml-2 text-blue-600 dark:text-blue-400"></i>
                ุชุตุฏูุฑ ุงูุฃุณุฆูุฉ
            </h3>
            
            <p class="text-gray-600 dark:text-gray-400 mb-6">
                ุชุตุฏูุฑ ุฌููุน ุงูุฃุณุฆูุฉ ุจุชูุณูู JSON ุฃู Excel ูููุณุฎ ุงูุงุญุชูุงุทู.
            </p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="exportToJSON()" 
                        class="p-4 bg-white dark:bg-gray-800 border border-blue-300 dark:border-blue-700 rounded-lg hover:border-blue-500 dark:hover:border-blue-500 transition-all group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center group-hover:bg-blue-200 dark:group-hover:bg-blue-800">
                            <i class="fas fa-file-code text-blue-600 dark:text-blue-400"></i>
                        </div>
                        <div class="text-left">
                            <div class="font-bold text-gray-900 dark:text-white">ุชุตุฏูุฑ JSON</div>
                            <div class="text-xs text-gray-500">ุชูุณูู ูุธูู</div>
                        </div>
                    </div>
                </button>
                
                <button onclick="exportToExcel()" 
                        class="p-4 bg-white dark:bg-gray-800 border border-green-300 dark:border-green-700 rounded-lg hover:border-green-500 dark:hover:border-green-500 transition-all group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900 flex items-center justify-center group-hover:bg-green-200 dark:group-hover:bg-green-800">
                            <i class="fas fa-file-excel text-green-600 dark:text-green-400"></i>
                        </div>
                        <div class="text-left">
                            <div class="font-bold text-gray-900 dark:text-white">ุชุตุฏูุฑ Excel</div>
                            <div class="text-xs text-gray-500">ุชูุณูู ุฌุฏููู</div>
                        </div>
                    </div>
                </button>
            </div>
        </div>
        
        <!-- ูุณู ุงูุงุณุชูุฑุงุฏ -->
        <div class="bg-gradient-to-r from-green-50 to-emerald-50 dark:from-green-900/20 dark:to-emerald-900/20 border border-green-200 dark:border-green-800 rounded-lg p-6">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-upload ml-2 text-green-600 dark:text-green-400"></i>
                ุงุณุชูุฑุงุฏ ุงูุฃุณุฆูุฉ
            </h3>
            
            <p class="text-gray-600 dark:text-gray-400 mb-6">
                ุงุณุชูุฑุงุฏ ุงูุฃุณุฆูุฉ ูู ููู JSON. ุณูุชู ุงุณุชุจุฏุงู ุฌููุน ุงูุฃุณุฆูุฉ ุงูุญุงููุฉ.
            </p>
            
            <div class="space-y-4">
                <!-- ููุทูุฉ ุฑูุน ุงูููู -->
                <div id="fileDropZone" 
                     class="border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-lg p-6 text-center transition-all hover:border-green-400 dark:hover:border-green-600 cursor-pointer">
                    <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                    <p class="text-gray-600 dark:text-gray-400 mb-2">ุงููุฑ ูุฑูุน ููู JSON</p>
                    <input type="file" id="jsonFileInput" 
                           accept=".json" 
                           class="hidden">
                    <div id="selectedFileName" class="mt-3 text-sm text-green-600 dark:text-green-400"></div>
                </div>
                
                <!-- ุชุฃููุฏ -->
                <div class="flex items-center gap-2 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                    <input type="checkbox" id="confirmImport" class="w-4 h-4">
                    <label for="confirmImport" class="text-yellow-700 dark:text-yellow-400 text-sm">
                        ุฃูุงูู ุนูู ุงุณุชุจุฏุงู ุงูุฃุณุฆูุฉ ุงูุญุงููุฉ
                    </label>
                </div>
                
                <!-- ุฃุฒุฑุงุฑ -->
                <div class="flex gap-3">
                    <button onclick="importFromJSON()" 
                            id="importBtn"
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        ุงุณุชูุฑุงุฏ
                    </button>
                    
                    <button onclick="resetImport()" 
                            class="px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg">
                        ุฅูุบุงุก
                    </button>
                </div>
                
                <!-- ุญุงูุฉ ุงูุงุณุชูุฑุงุฏ -->
                <div id="importStatus" class="hidden"></div>
            </div>
        </div>
        
        <!-- ูุณู ุงููุณุฎ ุงูุงุญุชูุงุทู -->
        <div class="bg-gradient-to-r from-purple-50 to-violet-50 dark:from-purple-900/20 dark:to-violet-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-6 mt-8">
            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                <i class="fas fa-history ml-2 text-purple-600 dark:text-purple-400"></i>
                ุงููุณุฎ ุงูุงุญุชูุงุทู
            </h3>
            
            <p class="text-gray-600 dark:text-gray-400 mb-4">
                ุฅุฏุงุฑุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงูุชููุงุฆูุฉ.
            </p>
            
            <div class="flex gap-3">
                <button onclick="createBackup()" 
                        class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold">
                    ุฅูุดุงุก ูุณุฎุฉ
                </button>
                
                <button onclick="restoreFromBackup()" 
                        id="restoreBtn"
                        class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold hidden">
                    ุงุณุชุนุงุฏุฉ
                </button>
            </div>
            
            <!-- ูุงุฆูุฉ ุงููุณุฎ -->
            <div id="backupList" class="mt-4 space-y-2 hidden"></div>
        </div>
    </div>
</div>
        
        <!-- ุตูุญุฉ ุณุฌู ุงููุดุงุท -->
        <div id="activityLogView" class="hidden">
           
               <!-- ุดุฑูุท ุงูุชุตููุฉ -->
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-5">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">

        <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">
                ููุน ุงููุดุงุท
            </label>
            <select id="activityTypeFilter"
                class="w-full h-10 px-3 rounded-lg border border-gray-300 dark:border-gray-600
                       bg-white dark:bg-gray-700 text-sm text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="all">ุฌููุน ุงูุฃููุงุน</option>
                <option value="ADD">ุฅุถุงูุฉ</option>
                <option value="EDIT">ุชุนุฏูู</option>
                <option value="DELETE">ุญุฐู</option>
                <option value="RESTORE">ุงุณุชุนุงุฏุฉ</option>
            </select>
        </div>

        <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">
                ุงููุณุชุฎุฏู
            </label>
            <select id="activityUserFilter"
                class="w-full h-10 px-3 rounded-lg border border-gray-300 dark:border-gray-600
                       bg-white dark:bg-gray-700 text-sm text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="all">ุฌููุน ุงููุณุชุฎุฏููู</option>
            </select>
        </div>

        <div>
            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">
                ุงููุญุฏุฉ
            </label>
            <select id="activityUnitFilter"
                class="w-full h-10 px-3 rounded-lg border border-gray-300 dark:border-gray-600
                       bg-white dark:bg-gray-700 text-sm text-gray-900 dark:text-white
                       focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="all">ุฌููุน ุงููุญุฏุงุช</option>
            </select>
        </div>

        <!-- ุฒุฑ ูุณุญ ุงูุณุฌู -->
        <div class="flex justify-end">
            <button onclick="clearActivityLogConfirmation()"
                id="clearActivityLogBtn"
                class="h-10 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg
                       flex items-center gap-2 text-sm font-semibold transition">
                <i class="fas fa-trash"></i>
                ูุณุญ ุงูุณุฌู
            </button>
        </div>

    </div>
</div>


                <!-- ุฌุฏูู ุณุฌู ุงููุดุงุท -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="overflow-x-auto overflow-y-auto max-h-[70vh]">
                        <table class="activity-table w-full text-sm">
                           <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0 z-20">
    <tr>
        <th class="px-4 py-3 text-right font-bold min-w-[120px] sticky top-0 bg-gray-100 dark:bg-gray-700">
            ุงูููุน
        </th>
        <th class="px-4 py-3 text-right font-bold min-w-[320px] sticky top-0 bg-gray-100 dark:bg-gray-700">
            ุงูุชูุงุตูู
        </th>
        <th class="px-4 py-3 text-right font-bold min-w-[150px] sticky top-0 bg-gray-100 dark:bg-gray-700">
            ุงููุญุฏุฉ
        </th>
        <th class="px-4 py-3 text-right font-bold min-w-[140px] sticky top-0 bg-gray-100 dark:bg-gray-700">
            ุงููุณุชุฎุฏู
        </th>
        <th class="px-4 py-3 text-right font-bold min-w-[170px] sticky top-0 bg-gray-100 dark:bg-gray-700">
            ุงูุชุงุฑูุฎ
        </th>
        <th class="px-4 py-3 text-right font-bold min-w-[120px] sticky top-0 bg-gray-100 dark:bg-gray-700">
            ุงูุฅุฌุฑุงุก
        </th>
    </tr>
</thead>


                            <tbody id="activityLogTableBody"
                                  class="divide-y divide-gray-200 dark:divide-gray-700">
                            </tbody>
                        </table>
                    </div>

                    <!-- ูุง ุชูุฌุฏ ุณุฌูุงุช -->
                    <div id="noActivityLogMessage" class="hidden text-center py-12">
                        <div class="text-5xl mb-4">๐</div>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">
                            ูุง ุชูุฌุฏ ุณุฌูุงุช ูุดุงุท
                        </h3>
                        <p class="text-gray-600 dark:text-gray-400">
                            ูู ูุชู ุชุณุฌูู ุฃู ูุดุงุท ุญุชู ุงูุขู
                        </p>
                    </div>

                    <!-- ุญุงูุฉ ุงูุชุญููู -->
                    <div id="loadingActivityLog" class="hidden text-center py-10">
                        <div class="loading-spinner inline-block mb-3"></div>
                        <p class="text-gray-600 dark:text-gray-400">
                            ุฌุงุฑู ุชุญููู ุณุฌู ุงููุดุงุท...
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ุงูุชูููุน ูุงููุคูู -->
    <div id="authorSignature" class="w-full max-w-3xl mx-auto p-6 mt-8 text-center bg-white/40 dark:bg-gray-900/40 backdrop-blur-lg border border-white/50 dark:border-gray-700 rounded-2xl shadow-lg transition-all duration-500 ease-out opacity-0 translate-y-8 hidden">
        <!-- ุฎุทูุท ุชุฒููููุฉ -->
        <div class="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-blue-400/80 to-purple-400/80 rounded-t-2xl"></div>
        <div class="absolute bottom-0 left-0 right-0 h-1.5 bg-gradient-to-r from-yellow-400 via-amber-500 to-yellow-400 rounded-b-2xl"></div>

        <!-- ููุงุญุธุฉ -->
        <div class="mb-6 relative z-10 text-right md:text-center">
            <p class="font-extrabold text-lg text-blue-700/90 dark:text-blue-400/90 mb-3 border-b border-blue-300/60 dark:border-blue-600/50 pb-2 inline-block">
                ๐ ููุงุญุธุฉ ูููุฉ ุฌุฏุงู
            </p>
            <ul class="list-disc list-outside space-y-2 pr-6 text-gray-800 dark:text-gray-300 font-medium text-sm leading-relaxed">
                <li>ุชู ุฌูุน ูุง ุชูุงูุฑ ูู ููุงุฐุฌ ุงููุงุฏุฉ ููุถุนูุง ูู ูุฐุง ุงููููุน.</li>
                <li>ููุฐุง ุงูุนูู ุงุฌุชูุงุฏ ุจุดุฑู ูุงุจู ููุตูุงุจ ูุงูุฎุทุฃ ูุงูุณูู ูุงููุณูุงู.</li>
                <li>ูุฐูู ูุณุนุฏูู ุงุณุชูุจุงู ุฃู ููุงุญุธุฉ ุฃู ุชุตููุจ ุนุจุฑ ุฃููููุฉ ุงูุชูุงุตู ุฃุฏูุงู ูุชุญุฏูุซ ุงููุญุชูู ุจุงุณุชูุฑุงุฑ.</li>
                <li class="mt-1 text-center list-none pt-1">
                    <span class="font-bold text-sm text-blue-800 dark:text-blue-400">
                        ุดุงูุฑูุง ููู ุชุนุงูููู ูุฑุงุฌูุงู ููู ุฏูุงู ุงูุชูููู.
                    </span>
                </li>
            </ul>
        </div>

        <!-- ุงูุงุณู ูุฒุฑ ูุงุชุณุงุจ -->
        <div class="flex items-center justify-center gap-6 pt-2">
            <p class="text-blue-900 dark:text-blue-400 font-black text-2xl tracking-widest">
                ูุญูุฏ ุงูุจุชููู
            </p>

            <a href="https://wa.me/967775105531" target="_blank" 
               class="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition-colors">
                <i class="fab fa-whatsapp text-lg"></i>
                ุชูุงุตู ูุนู
            </a>
        </div>
    </div>

    <!-- ููุฎุตุงุช ุงููุชุงุฆุฌ -->
    <div id="quizCompletionSummary" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t-2 shadow-[0_-5px_15px_rgba(0,0,0,0.1)] p-4 transform translate-y-full transition-all duration-300 ease-out z-50 hidden">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="text-center sm:text-right">
                <h4 id="summaryQuizTitle" class="font-bold text-lg text-gray-900 dark:text-white flex items-center gap-2">
                    <span id="summaryQuizIcon">๐</span>
                    <span>ุชู ุฅููุงุก ุงูุงุฎุชุจุงุฑ ุจูุฌุงุญ</span>
                </h4>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                    ุฅุฌูุงูู ุงูุฃุณุฆูุฉ: <span id="summaryTotalCount" class="font-bold">0</span> | ุงูุตุญูุญุฉ: <span id="summaryCorrectCount" class="text-green-600 font-bold">0</span> | ุงูุฎุงุทุฆุฉ: <span id="summaryWrongCount" class="text-red-600 font-bold">0</span> | ุงูุฏูุฉ: <span id="summaryAccuracy" class="text-blue-600 dark:text-blue-400 font-bold">0%</span>
                </p>
            </div>
            <div class="flex gap-3">
                <button id="summaryReviewBtn" class="px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-lg transition-colors flex items-center gap-2 hidden">ูุฑุงุฌุนุฉ ุงูุฃุฎุทุงุก (0)</button>
                <button id="summaryBackBtn" class="px-5 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold rounded-lg shadow-lg transition-colors dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">ุงูุนูุฏุฉ ูููุญุฏุงุช</button>
            </div>
        </div>
    </div>

    <div id="practiceRoundSummary" class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t-2 border-primary shadow-[0_-5px_15px_rgba(0,0,0,0.1)] p-4 transform translate-y-full transition-transform duration-300 z-50 hidden">
        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="text-center sm:text-right">
                <h4 class="font-bold text-lg text-gray-900 dark:text-white">ุงูุชูุช ุงูุฌููุฉ ุงูุญุงููุฉ ๐</h4>
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    ุฃุญุณูุช! ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ: <span id="roundCorrectCount" class="text-green-600 font-bold text-base">0</span> | ูุชุจูู ูููุฑุงุฌุนุฉ: <span id="roundWrongCount" class="text-red-600 font-bold text-base">0</span>
                </p>
            </div>
            <button id="nextRoundBtn" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg transition-colors flex items-center gap-2">
                <span>ุจุฏุก ุงูุฌููุฉ ุงูุชุงููุฉ</span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 9l3 3m0 0l-3 3m3-3H8m13 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
        </div>
    </div>

    <script>
        
        
        
        
        
       // ==========================================
// 1. ุงูุซูุงุจุช ูุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ
// ==========================================
const TR_FA = ["ุตุญ", "ุฎุทุฃ"];

// ==========================================
// 2. ุฃุณุฆูุฉ ุตุญ / ุฎุทุฃ
// ==========================================
let trueFalseQuestionsData = [
    {
        question: "ุชุนุฑู ุงูุฌูุฏุฉ ุจุฃููุง ุฏุฑุฌุฉ ุงูุชููู ูุงูุฃูุชูุงุฒ ุงูุชู ููุฏููุง ุงูููุชุฌ ูุฐุง ุงูุชุนุฑูู ูุจูู ุนูู ุงูููุชุฌ",
        options: TR_FA,
        answerIndex: 1,
        explanation: "ูุฐุง ุงูุชุนุฑูู ูุฑูุฒ ุนูู ุฎุตุงุฆุต ุงูููุชุฌ ุฐุงุชูุงุ ุจูููุง ุงูุชุนุฑูู ุงููุทูู ููุฌูุฏุฉ ูุชุฌุงูุฒ ุงูุฎุตุงุฆุต ุฅูู ุงูุชุญุณูู ุงููุณุชูุฑ ุฏูู ุญุฏูุฏ.",
        page: "12"
    },
    {
        question: "ุญุตุฑุช ุงููุฏุงุฎู ุงูุฎูุณุฉ ูุชุนุฑูู ุงูุฌูุฏุฉ ุนู ุทุฑูู ุงูุนุงูู ุฏูููุฏ ุฌุงุฑููู",
        options: TR_FA,
        answerIndex: 0,
        explanation: "ูุงู ุฏูููุฏ ุฌุงุฑููู ุจุชุตููู ููููู ุงูุฌูุฏุฉ ุฅูู ุฎูุณุฉ ูุฏุงุฎู ูุชูุณูุฑูุง ูู ุฒูุงูุง ุฅุฏุงุฑูุฉ ูุณูููุฉ ูุฅูุชุงุฌูุฉ ูุฎุชููุฉ.",
        page: "12"
    },
    {
        question: "ูุฑู ุชุงุฌูุดู ุจุฃู ุงูุฌูุฏุฉ ุชูุงุฏู ุงูุฎุณุงุฑุฉ ุงูุชู ูุณุจุจูุง ุงูููุชุฌ ูููุฌุชูุน ุจุนุฏ ุงุฑุณุงูู ูููุณุชุนูู",
        options: TR_FA,
        answerIndex: 0,
        explanation: "ูุฑุจุท ุชุงุฌูุดู ุงูุฌูุฏุฉ ุจุชูููู ุงูุฎุณุงุฆุฑ ุงูุงุฌุชูุงุนูุฉ ุทูููุฉ ุงููุฏู ุงููุงุชุฌุฉ ุนู ุงุณุชุฎุฏุงู ุงูููุชุฌ ูููุณ ููุท ุจุฌูุฏุฉ ุงูุชุตููุน.",
        page: "14"
    }
];

// ==========================================
// 3. ุฃุณุฆูุฉ ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ (ุงุฎุชูุงุฑ ูุงุญุฏ)
// ==========================================
let mcqQuestionsData = [
    {
        question: "ุงูุฏุฑุฌุฉ ุงูุชู ุชุดุจุน ูููุง ุงูุญุงุฌุงุช ูุงูุชููุนุงุช ุงูุธุงูุฑูุฉ ูุงูุถูููุฉ ูู ุฎูุงู ุฌููุฉ: ุนุฑูุช ุงูุฌูุฏุฉ ุจุงููุง ุงูุฎุตุงุฆุต ุงูุฑุฆูุณูุฉ ุงููุญุฏุฏุฉ ูุณุจูุง",
        options: [
            "ุงูููุธูุฉ ุงูุฏูููุฉ ููููุงุตูุงุช",
            "ุงูุฌูุนูุฉ ุงูุฃูุฑูููุฉ ูุถุจุท ุงูุฌูุฏุฉ",
            "ุงูููุธูุฉ ุงูุฃูุฑูููุฉ ูุถุจุท ุงูุฌูุฏุฉ",
            "ุงูููุธูุฉ ุงูุนุฑุจูุฉ ูุถุจุท ุงูุฌูุฏุฉ"
        ],
        answerIndex: 0,
        explanation: "ูุฑูุฒ ุชุนุฑูู ISO ุนูู ูุฏู ุชุญููู ุงูููุชุฌ ููุชุทูุจุงุช ูุชููุนุงุช ุงูุนููุงุก ุงููุนููุฉ ูุบูุฑ ุงููุนููุฉ.",
        page: "12"
    },
    {
        question: "ูุนุฑู ุงูุฌูุฏุฉ ุจุงููุง ุงููุทุงุจูุฉ ูููุชุทูุจุงุช ุงู ุงูููุงุตูุงุช ูู",
        options: ["ASQC", "Taguchi", "Crosby", "Gilmore"],
        answerIndex: 2,
        explanation: "ูุฑู ูุฑูุณุจู ุฃู ุงูุฌูุฏุฉ ุชุชุญูู ุนูุฏูุง ูุทุงุจู ุงูููุชุฌ ุงูููุงุตูุงุช ุงููุญุฏุฏุฉ ุฏูู ุงูุญุฑุงูุ ูููุณ ุจุฏุฑุฌุฉ ุงูุฅุชูุงู.",
        page: "13"
    },
    {
        question: "ูุนุชุจุฑ ุงููุฏุฎู ุงูุงุฎูุฑ ูู ูุฏุงุฎู ุชุนุฑูู ุงูุฌูุฏุฉ ุจุญุณุจ ุญุตุฑ ุฏูููุฏ ุฌุงุฑููู",
        options: [
            "ุงูุฏุฎู ุงููุจูู ุนูู ุงูููุชุฌ",
            "ุงููุฏุฎู ุงููุจูู ุนูู ุงููููุฉ",
            "ุงููุฏุฎู ุงููุจูู ุนูู ุงูุนููู",
            "ุงููุฏุฎู ุงููุจูู ุนูู ุงูุชุตููุน"
        ],
        answerIndex: 1,
        explanation: "ูุฑุจุท ุงููุฏุฎู ุงููููู ุงูุฌูุฏุฉ ุจุชูุงุฒู ุงูููุงูุน ุงูุชู ูุญุตู ุนูููุง ุงูุนููู ููุงุจู ุงูุชูููุฉ ุงูุชู ูุฏูุนูุง.",
        page: "13"
    }
];

// ==========================================
// 4. ุฃุณุฆูุฉ ุงุฎุชูุงุฑ ูุชุนุฏุฏ
// ==========================================
let multiSelectQuestionsData = [
    {
        question: "ูู ููุงุฆุฏ ุงุฏุงุฑุฉ ุงูุฌูุฏุฉ ูููุฌุชูุน",
        options: [
            "ุฒูุงุฏุฉ ุฑุถุง ุงูุนุงูููู",
            "ุฒูุงุฏุฉ ูุฑุต ุงูุนูู",
            "ุชุญุณูู ุงูุตุญุฉ ู ุงูุงูุงู",
            "ุงูุฎูุงุถ ุดูุงูุฆ ุงูุนููุง ุงูุฏุงุฎูููู ู ุงูุฎุงุฑุฌููู"
        ],
        answers: [1, 2],
        explanation: "ุชุณูู ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ูู ุฎูู ุจูุฆุฉ ุนูู ุขููุฉ ููุณุชูุฑุฉุ ููุง ููุนูุณ ุฅูุฌุงุจูุง ุนูู ุงููุฌุชูุน ูุณูู ุงูุนูู.",
        page: "22"
    },
    {
        question: "ูู ููุงุฆุฏ ุงุฏุงุฑุฉ ุงูุฌูุฏุฉ ููููุฑุฏูู ููุตูุนู ุงูุงุฌุฒุงุก",
        options: [
            "ุชุญููู ุดุฑุงูุฉ ุทูููุฉ ูุน ุงูููุธูุฉ",
            "ุฒูุงุฏุฉ ุณุนุฑ ุงูุณูู",
            "ุชุญููู ุงูููู",
            "ุชุทููุฑ ูุชุงุฆุฌ ุงูุชุดุบูู"
        ],
        answers: [0, 2],
        explanation: "ุชุนุฒุฒ ุฅุฏุงุฑุฉ ุงูุฌูุฏุฉ ุงุณุชูุฑุงุฑูุฉ ุงูุนูุงูุฉ ูุน ุงูููุฑุฏูู ูุชุฏุนู ููููู ูู ุฎูุงู ุงูุงุณุชูุฑุงุฑ ูุชุญุณูู ุงูุชูุณูู.",
        page: "22"
    },
    {
        question: "ูุฑุญูุฉ ุชุฃููุฏ ุงูุฌูุฏุฉ ูุถูุงูุงุชูุง ุชุฃุชู ุจุนุฏ ุงููุฑุงุญู ุงูุขุชูุฉ",
        options: [
            "ุงูุฑูุงุจุฉ ุงูุฅุญุตุงุฆูุฉ",
            "ุงููุญุต ูุงูุชูุชูุด"
        ],
        answers: [0, 1],
        explanation: "ุชุฃุชู ูุฑุญูุฉ ุชุฃููุฏ ุงูุฌูุฏุฉ ุจุนุฏ ุงูุงูุชูุงู ูู ุงูุชุดุงู ุงูุฃุฎุทุงุก ุฅูู ุงูุชุญูู ูููุง ุซู ููุนูุง ูุณุจููุง.",
        page: "24"
    }
];


// ==========================================
// 5. ุงูุฃุณุฆูุฉ ุงูููุงููุฉ (ููุงููู)
// ==========================================
let qaQuestionsData = [
    { type: "note", text: "ุชู ุชุฑุชูุจ ุงูููู" },
    { type: "header", text: "ุงููุญุฏุฉ ุงูุฃููู: ูุงููุฉ ุงูุฌูุฏุฉ" },

    {
        question: "ูุง ุงููุฑู ุจูู ุชุนุฑูู ุงูุฌูุฏุฉ ูู ูุฌูุฉ ูุธุฑ ุงูุนููู ูุจูู ุชุนุฑูููุง ูู ูุฌูุฉ ูุธุฑ ุงูุชุตููุนุ ููุถุญุงู ุฃูููุง ุฃูุซุฑ ุงูุชูุงูุงู ูู ูุจู ุฅุฏุงุฑุชู ุงูุฅูุชุงุฌ ูุงูุชุณูููุ",
        answer: `
ูู ูุฌูุฉ ูุธุฑ ุงูุนููู:
ูุฑูุฒ ุงูุชุนุฑูู ุนูู ุงูุชูุถููุงุช ุงูุชู ูุทูุจูุง ุงูุนููู ูู ุงูููุชุฌุ ูุงูููุชุฌุงุช ุงูุชู ุชุญูู ุฃุนูู ุฅุดุจุงุน ููุฐู ุงูุชูุถููุงุช ูู ุงูุฃุนูู ุฌูุฏุฉ.

ูู ูุฌูุฉ ูุธุฑ ุงูุชุตููุน:
ูุฑูุฒ ุงูุชุนุฑูู ุนูู ุงูููุงุตูุงุช ูุงููุชุทูุจุงุช ุงููุงุฌุจ ุชุญููููุง ูู ุงูููุชุฌุ ูุงูููุชุฌุงุช ุงููุทุงุจูุฉ ููููุงุตูุงุช ูู ุงูุฃุนูู ุฌูุฏุฉ.

ุงูุงูุชูุงู ุงูุฅุฏุงุฑู:
- ุฅุฏุงุฑุฉ ุงูุชุณููู: ุชูุชู ุฃูุซุฑ ุจุชุนุฑูู ุงูุฌูุฏุฉ ูู ูุฌูุฉ ูุธุฑ ุงูุนููู.
- ุฅุฏุงุฑุฉ ุงูุฅูุชุงุฌ: ุชูุชู ุฃูุซุฑ ุจุชุนุฑูู ุงูุฌูุฏุฉ ูู ูุฌูุฉ ูุธุฑ ุงูุชุตููุน.
        `,
        page: "15 & 45"
    },
    {
        question: "ูุงูุด ุงูุชุนุฑูู ุงูุดุงูู ููุฌูุฏุฉุ ูุจููุงู ุฑุฃูู ุงูุฎุงุตุ",
        answer: `
ุงูุชุนุฑูู ุงูุดุงูู ููุฌูุฏุฉ:
ุฏุฑุฌุฉ ุชููู ุงูููุชุฌ ุงูุฐู ูุชุตู ุจูุฌููุนุฉ ูู ุงูุตูุงุช ุงููุทุงุจูุฉ ููููุงุตูุงุช ุงููุฎุทุท ููุงุ ูุงูุชู ูุชู ุชุทููุฑูุง ูุชุญุณูููุง ุจุดูู ูุณุชูุฑุ ุจูุง ููุจู ุญุงุฌุงุช ุงูุนููู ูุฑุบุจุงุชู ุงููุชุบูุฑุฉ ุฃู ูุชุฌุงูุฒูุงุ ุจุณุนุฑ ูุนููู ูุจุฏูู ุฅูุญุงู ุฃู ุฎุณุงุฑุฉ ุจุงููุฌุชูุน.


ูุชุถุญ ูู ุงูุชุนุฑูู ุฃูู ูุดูู:
1. ุงูุฌูุฏุฉ ูู ูุฌูุฉ ูุธุฑ ุงูุนููู.
2. ุงูุฌูุฏุฉ ูู ูุฌูุฉ ูุธุฑ ุงูุชุตููุน.
3. ุงูุฌูุฏุฉ ูู ูุฌูุฉ ูุธุฑ ุงูููุชุฌ / ุงููููุฉ.
4. ุงูุฌูุฏุฉ ูู ูุฌูุฉ ูุธุฑ ุงููุฌุชูุน.
5. ุงูุฌูุฏุฉ ูู ูุฌูุฉ ุงููุธุฑ ุงููุทููุฉ (ุงูุชุญุณูู ุงููุณุชูุฑ).
        `,
        page: "14"
    }
];

// ==========================================
// 6. ุชุฌููุน ุงููุญุฏุงุช
// ==========================================
const unitsData = [
    { id: 1, title: "ุตุญูุญ ูุฎุทุฃ", type: "mcq-single-tf", questions: trueFalseQuestionsData, icon: "โ๏ธ" },
    { id: 2, title: "ุงุฎุชูุงุฑ ูุญูุฏ", type: "mcq-single", questions: mcqQuestionsData, icon: "๐ง" },
    { id: 3, title: "ุงุฎุชูุงุฑ ูุชุนุฏุฏ", type: "mcq-multi", questions: multiSelectQuestionsData, icon: "๐ข" },
    { id: 4, title: "ุฃุณุฆูุฉ ููุงููุฉ (ููุงููู)", type: "qa-display", questions: qaQuestionsData, icon: "โ" }
];





const STORAGE_KEYS = {
    ANSWERS: 'MyNewQuiz_V23',
    FAVORITES:'MyNewQuiz_Favorites23',
    THEME: 'theme23',
    USER_DATA: 'MyNewQuiz_UserData23',
    BACKUPS: 'MyNewQuiz_BUI_ICONS23'  
};


const UI_ICONS = {
    sun: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z" />`,
    moon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />`,
    eyeShow: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />`,
    eyeHide: `<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 0 0 1.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.451 10.451 0 0 1 12 4.5c4.756 0 8.773 3.162 10.065 7.498a10.522 10.522 0 0 1-4.293 5.774M6.228 6.228 3 3m3.228 3.228 3.65 3.65m7.894 7.894L21 21m-3.228-3.228-3.65-3.65m0 0a3 3 0 1 0-4.243-4.243m4.242 4.242L9.88 9.88" />`
};

// ==========================================
// 2. ุญุงูุฉ ุงูุชุทุจูู (ุจุฏูู ุฏูุงู ุงูุจุญุซ)
// ==========================================
let appState = {
    userAnswers: {},
    currentUnit: null,
    multiSelectionState: {},
    solutionsVisible: false,
    activeQuestionIndex: 0,
    favorites: {},
    firebaseUser: null,
    isSyncing: false,
    lastSyncTime: null,
    contentManagementMode: false,
    editingQuestionIndex: null,
    currentContentUnit: null,
    currentUser: null,
    editingUserId: null,
    currentView: 'units'
};

// ==========================================
// ุฏูุงู ุงููุณุงุนุฏุฉ ุงูุฃุณุงุณูุฉ
// ==========================================
function formatAnswerText(text) {
    const container = document.createElement("div");
    container.className = "space-y-3";

    const parts = text.split(/(<table[\s\S]*?<\/table>)/gi);

    parts.forEach(part => {
        if (!part.trim()) return;

        if (part.trim().toLowerCase().startsWith("<table")) {
            const tableWrapper = document.createElement("div");
            tableWrapper.className = "w-full overflow-x-auto my-2";
            tableWrapper.innerHTML = part;
            container.appendChild(tableWrapper);
        } else {
            processTextContent(part.trim(), container);
        }
    });

    return container;
}

function processTextContent(text, container) {
    const lines = text.split("\n");
    let currentList = null;

    lines.forEach(line => {
        const trimmed = line.trim();
        if (!trimmed) return;

        if (trimmed.endsWith(':') && trimmed.length < 60) {
            const head = document.createElement("h5");
            head.className = "text-blue-800 dark:text-blue-400 font-bold mt-6 mb-3 flex items-center border-b pb-1 border-blue-100 dark:border-blue-900";
            head.innerHTML = `<span class="w-1.5 h-5 bg-blue-600 ml-2 rounded-full"></span>${trimmed}`;
            container.appendChild(head);
            currentList = null;
        } else if (trimmed.startsWith('-') || trimmed.startsWith('*')) {
            if (!currentList) {
                currentList = document.createElement("ul");
                currentList.className = "list-none pr-5 space-y-2 mb-5";
                container.appendChild(currentList);
            }
            const li = document.createElement("li");
            li.className = "flex items-start text-gray-800 dark:text-gray-200 text-sm md:text-base";
            const content = trimmed.substring(1).trim();
            li.innerHTML = `<span class="text-blue-500 ml-2 mt-1.5 flex-shrink-0" style="font-size: 8px;">โ</span><span>${content}</span>`;
            currentList.appendChild(li);
        } else {
            const p = document.createElement("p");
            p.className = "text-base leading-relaxed text-gray-700 dark:text-gray-300 mb-4 text-justify";
            
            let formattedText = trimmed
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-blue-900 dark:text-blue-200">$1</strong>')
                .replace(/\((.*?)\)/g, '<span class="text-emerald-700 dark:text-emerald-400 font-medium">($1)</span>');
            
            p.innerHTML = formattedText;
            container.appendChild(p);
            currentList = null;
        }
    });
}

// ==========================================
// ุฅุฏุงุฑุฉ ุงูุชุฎุฒูู (ุชู ุฅุฒุงูุฉ SEARCH_STATE)
// ==========================================
function loadStorageData() {
    const rawAnswers = localStorage.getItem(STORAGE_KEYS.ANSWERS);
    try {
        appState.userAnswers = rawAnswers ? JSON.parse(rawAnswers) || {} : {};
    } catch {
        appState.userAnswers = {};
    }

    const rawFavorites = localStorage.getItem(STORAGE_KEYS.FAVORITES);
    try {
        const favObject = rawFavorites ? JSON.parse(rawFavorites) || {} : {};
        appState.favorites = {};
        Object.keys(favObject).forEach(unitId => {
            appState.favorites[unitId] = new Set(favObject[unitId]);
        });
    } catch {
        appState.favorites = {};
    }

    // ุชู ููู ุญุงูุฉ ุงูุจุญุซ ุฅูู SearchManager
}

function saveStorageData() {
    localStorage.setItem(STORAGE_KEYS.ANSWERS, JSON.stringify(appState.userAnswers));

    const favObject = {};
    Object.keys(appState.favorites).forEach(unitId => {
        favObject[unitId] = [...appState.favorites[unitId]];
    });
    localStorage.setItem(STORAGE_KEYS.FAVORITES, JSON.stringify(favObject));

    // ุชู ููู ุญุงูุฉ ุงูุจุญุซ ุฅูู SearchManager
}

// ==========================================
// ุฏูุงู ูุงุฌูุฉ ุงููุณุชุฎุฏู ุงููุชูุฏูุฉ (ุชู ุชุญุฏูุซูุง)
// ==========================================
function updateTheme(isDark) {
    document.documentElement.classList.toggle('dark', isDark);
    const iconPath = isDark ? UI_ICONS.sun : UI_ICONS.moon;
    
    [document.getElementById('themeIcon'), document.getElementById('dropdownThemeIcon')].forEach(icon => { 
        if(icon) icon.innerHTML = iconPath; 
    });
    
    localStorage.setItem(STORAGE_KEYS.THEME, isDark ? 'dark' : 'light');
}

// ==========================================
// ุฏูุงู ุนุฑุถ ุงูููุงุฐุฌ ุงูููุจุซูุฉ
// ==========================================
function showLoginModal() {
    document.getElementById('loginModal').classList.add('active');
}

function hideLoginModal() {
    document.getElementById('loginModal').classList.remove('active');
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('signupForm').classList.add('hidden');
    document.getElementById('loginMessage').classList.add('hidden');
}

function showLoginForm() {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('signupForm').classList.add('hidden');
    document.getElementById('loginMessage').classList.add('hidden');
}

function showSignupForm() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('signupForm').classList.remove('hidden');
    document.getElementById('loginMessage').classList.add('hidden');
}

// ==========================================
// ุฏูุงู ุงูุชููู ูุงูุนุฑุถ (ุชู ุชุญุฏูุซูุง)
// ==========================================
function hideAllViews() {
    const allViews = [
        'unitsView',
        'questionsView',
        'contentManagementView',
        'usersManagementView',
        'backupManagementView',
        'activityLogView'
    ];
    
    allViews.forEach(viewId => {
        const viewElement = document.getElementById(viewId);
        if (viewElement) {
            viewElement.classList.add('hidden');
            // ุฅุนุงุฏุฉ ุชุนููู ุงูุฃููุงุท
            viewElement.style.display = 'none';
            viewElement.style.opacity = '0';
            viewElement.style.visibility = 'hidden';
        }
    });
}

function restoreMenuButtons() {
    // โ ุงุณุชุนุงุฏุฉ ุงูุฃุฒุฑุงุฑ ุนูุฏ ุงูุนูุฏุฉ ููุญุฏุงุช ุฃู ุฃุณุฆูุฉ ุนุงุฏูุฉ
    const favoritesBtn = document.getElementById('toggleFavoritesSmartDropdown');
    const solutionsBtn = document.getElementById('toggleSolutionsBtn');
    const resetBtn = document.getElementById('resetUnitTop');
    
    if (favoritesBtn) favoritesBtn.classList.remove('hidden');
    if (solutionsBtn) solutionsBtn.classList.remove('hidden');
    if (resetBtn) resetBtn.classList.remove('hidden');
}

function showUnitsView(isPopState = false) {
    hideAllViews();
    
    appState.currentUnit = null;
    appState.multiSelectionState = {};
    appState.solutionsVisible = false;
    appState.activeQuestionIndex = 0;
    appState.contentManagementMode = false;
    appState.editingQuestionIndex = null;
    appState.currentContentUnit = null;
    appState.currentView = 'units';
    
    hideAllSummaries();
    
    // ูุณุญ ุงูุจุญุซ
    if (typeof SearchManager !== 'undefined') {
        SearchManager.clearSearch(appState);
    }
    
    if (appState.scrollObserver) {
        appState.scrollObserver.disconnect();
        appState.scrollObserver = null;
    }

    document.getElementById('unitInfoContainer')?.classList.remove('hidden');
    document.getElementById('fixedTopBar').classList.add('hidden');
    document.getElementById('mainHeader').classList.remove('hidden');
    document.body.style.paddingTop = "0";
    document.getElementById('authorSignature').classList.remove('hidden');
    
    // โ ุงุณุชุนุงุฏุฉ ุงูุฃุฒุฑุงุฑ
    restoreMenuButtons();
    
    // ุฅุธูุงุฑ ุตูุญุฉ ุงููุญุฏุงุช
    const unitsView = document.getElementById('unitsView');
    unitsView.classList.remove('hidden');
    unitsView.style.display = 'block';
    unitsView.style.opacity = '1';
    unitsView.style.visibility = 'visible';
    
    updateSolutionUI(false);
    renderUnits();
    updateOverallStats();
    
    if (!isPopState) {
        history.pushState({ view: 'units' }, '', '#units');
    }
}

function showUnitQuestions(unit, mode = 'normal') {
    hideAllViews();
    
    appState.currentUnit = unit;
    appState.solutionsVisible = false;
    appState.currentUnit.mode = mode;
    appState.activeQuestionIndex = 0;
    appState.contentManagementMode = false;
    appState.currentView = 'questions';

    // ุฅุธูุงุฑ ุตูุญุฉ ุงูุฃุณุฆูุฉ
    const questionsView = document.getElementById('questionsView');
    questionsView.classList.remove('hidden');
    questionsView.style.display = 'block';
    questionsView.style.opacity = '1';
    questionsView.style.visibility = 'visible';
    
    document.getElementById('fixedTopBar').classList.remove('hidden');
    document.getElementById('mainHeader').classList.add('hidden');
    document.body.style.paddingTop = "70px";
    document.getElementById('authorSignature').classList.add('hidden');
    
    // โ ุงุณุชุนุงุฏุฉ ุงูุฃุฒุฑุงุฑ (ูุน ุชุนุฏููุงุช ุฎุงุตุฉ)
    const favoritesBtn = document.getElementById('toggleFavoritesSmartDropdown');
    const solutionsBtn = document.getElementById('toggleSolutionsBtn');
    const resetBtn = document.getElementById('resetUnitTop');
    
    if (favoritesBtn) favoritesBtn.classList.remove('hidden');
    if (resetBtn) resetBtn.classList.remove('hidden');
    
    // ุฒุฑ ุฅุธูุงุฑ ุงูุญููู ูุธูุฑ ููุท ูู ุงูุฃุณุฆูุฉ ุงูุนุงุฏูุฉ (ููุณ ุงูููุงููุฉ)
    if (unit.type !== 'qa-display') {
        if (solutionsBtn) solutionsBtn.classList.remove('hidden');
    } else {
        if (solutionsBtn) solutionsBtn.classList.add('hidden');
    }
    
    // ุชุญุฏูุซ ูุงุฌูุฉ ุงูุจุญุซ
    if (typeof SearchManager !== 'undefined') {
        SearchManager.updateUI(appState);
        SearchManager.updateSearchState(appState);
    }

    if (unit.type === 'qa-display') {
        document.getElementById('resetUnitTop')?.classList.add('hidden');
        document.getElementById('toggleSolutionsBtn')?.classList.add('hidden');
        document.getElementById('printQuestionsBtn')?.classList.remove('hidden');
        document.getElementById('unitTitleTop').textContent = unit.title + (mode === 'favorites' ? " (ุงูุฃุณุฆูุฉ ุงูููุถูุฉ)" : "");
        renderQAQuestions(unit, mode);
        updateUnitProgress();
        history.pushState({ view: 'qa', unitId: unit.id, mode: mode }, '', `#unit-${unit.id}-${mode}`);
        updateFavoriteUI(unit.id.toString());
        updateToggleFavoritesButton();
        return;
    }
    
    document.getElementById('resetUnitTop')?.classList.remove('hidden');
    document.getElementById('toggleSolutionsBtn')?.classList.remove('hidden');
    
    updateSolutionUI(false);

    let questionsToRender = unit.questions;
    if (mode === 'practice') {
        const unitAnswers = appState.userAnswers[unit.id] || {};
        questionsToRender = unit.questions
            .map((q, index) => ({ ...q, originalIndex: index }))
            .filter(({ originalIndex }) => {
                const answer = unitAnswers[originalIndex];
                return answer && answer.correct === false;
            });
        document.getElementById('unitTitleTop').textContent = unit.title + " (ูุฑุงุฌุนุฉ ุงูุฃุฎุทุงุก)";
    } else if (mode === 'favorites') {
        const favSet = appState.favorites[unit.id] || new Set();
        questionsToRender = unit.questions
            .map((q, index) => ({ ...q, originalIndex: index }))
            .filter(({ originalIndex }) => favSet.has(originalIndex));
        document.getElementById('unitTitleTop').textContent = unit.title + " (ุงูุฃุณุฆูุฉ ุงูููุถูุฉ)";
    } else {
        document.getElementById('unitTitleTop').textContent = unit.title;
    }
    
    appState.currentUnit.filteredQuestions = questionsToRender;
    updateUnitProgress();
    renderQuestions(questionsToRender, unit.type);
        
    setTimeout(() => {
        if (questionsToRender.length === 0 && (mode === 'practice' || mode === 'favorites')) {
            if (mode === 'practice') {
                showToast('ูุง ุชูุฌุฏ ุฃุฎุทุงุก ูููุฑุงุฌุนุฉ ูู ูุฐู ุงููุญุฏุฉ.', 'info');
            } else if (mode === 'favorites') {
                showToast('ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ููุถูุฉ ูู ูุฐู ุงููุญุฏุฉ.', 'info');
            }
            showUnitQuestions(unit, 'normal');
            return;
        }
        
        let targetIdx = 0;
        for (let i = 0; i < questionsToRender.length; i++) {
            const origIdx = questionsToRender[i].originalIndex ?? i;
            const unitAnswers = appState.userAnswers[unit.id] || {};
            if (!unitAnswers[origIdx] && mode !== 'favorites') {
                targetIdx = i;
                break;
            }
        }
        setActiveQuestion(targetIdx, 'instant');
    }, 100);
    
    history.pushState({ view: 'questions', unitId: unit.id, mode: mode }, '', `#unit-${unit.id}-${mode}`);
    
    updateFavoriteUI(unit.id.toString());
    updateToggleFavoritesButton();
}


function showContentManagement(unit) {
    if (!checkAndUpdateUI()) {
        showLoginModal();
        return;
    }
    
    if (!checkPermission('canAccessAdmin')) {
        showToast('ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ุฅูู ุฅุฏุงุฑุฉ ุงููุญุชูู', 'error');
        return;
    }
    
    hideAllViews();
    
    appState.currentContentUnit = unit;
    appState.contentManagementMode = true;
    appState.editingQuestionIndex = null;
    appState.currentView = 'content';

    // ุฅุธูุงุฑ ุตูุญุฉ ุฅุฏุงุฑุฉ ุงููุญุชูู
    const contentView = document.getElementById('contentManagementView');
    contentView.classList.remove('hidden');
    contentView.style.display = 'block';
    contentView.style.opacity = '1';
    contentView.style.visibility = 'visible';
    
    document.getElementById('fixedTopBar').classList.remove('hidden');
    document.getElementById('mainHeader').classList.add('hidden');
    document.body.style.paddingTop = "70px";
    document.getElementById('authorSignature').classList.add('hidden');
    
    document.getElementById('unitTitleTop').textContent = unit.title + " - ุฅุฏุงุฑุฉ ุงููุญุชูู";
    
    // ุชุญุฏูุซ ูุงุฌูุฉ ุงูุจุญุซ
    if (typeof SearchManager !== 'undefined') {
        SearchManager.updateUI(appState);
        SearchManager.updateSearchState(appState);
    }
    
    document.getElementById('toggleSolutionsBtn')?.classList.add('hidden');
    document.getElementById('resetUnitTop')?.classList.add('hidden');
    
    renderContentManagement(unit);
    
    history.pushState({ view: 'content-management', unitId: unit.id }, '', `#content-management-${unit.id}`);
}

function showUsersManagement() {
    if (!checkAndUpdateUI()) {
        showLoginModal();
        return;
    }
    
    if (!checkPermission('canUsers')) {
        showToast('ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ุฅูู ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู', 'error');
        return;
    }
    
    hideAllViews();
    
    appState.currentView = 'users';

    const usersView = document.getElementById('usersManagementView');
    usersView.classList.remove('hidden');
    usersView.style.display = 'block';
    usersView.style.opacity = '1';
    usersView.style.visibility = 'visible';
    
    document.getElementById('mainHeader').classList.add('hidden');
    document.getElementById('fixedTopBar').classList.remove('hidden');
    document.body.style.paddingTop = "70px";
    document.getElementById('authorSignature').classList.add('hidden');
    
    document.getElementById('unitTitleTop').textContent = 'ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู';
    
    // โ ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ ุงููุทููุจุฉ ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
    document.getElementById('toggleFavoritesSmartDropdown').classList.add('hidden');
    document.getElementById('toggleSolutionsBtn').classList.add('hidden');
    document.getElementById('resetUnitTop').classList.add('hidden');
    
    if (typeof loadUsersForPage === 'function') {
        loadUsersForPage();
    }
    
    if (typeof setupUserManagementEvents === 'function') {
        setupUserManagementEvents();
    }
}

function showActivityLogView() {
    if (!checkAndUpdateUI()) {
        showLoginModal();
        return;
    }
    
    if (!checkPermission('canViewActivityLog')) {
        showToast('ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ุฅูู ุณุฌู ุงููุดุงุท', 'error');
        return;
    }
    
    hideAllViews();
    
    appState.currentView = 'activityLog';

    const activityLogView = document.getElementById('activityLogView');
    activityLogView.classList.remove('hidden');
    activityLogView.style.display = 'block';
    activityLogView.style.opacity = '1';
    activityLogView.style.visibility = 'visible';
    
    document.getElementById('fixedTopBar').classList.remove('hidden');
    document.getElementById('mainHeader').classList.add('hidden');
    document.body.style.paddingTop = "70px";
    document.getElementById('authorSignature').classList.add('hidden');
    
    document.getElementById('unitTitleTop').textContent = 'ุณุฌู ุงููุดุงุท';
    
    // โ ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ ุงููุทููุจุฉ ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
    document.getElementById('toggleFavoritesSmartDropdown').classList.add('hidden');
    document.getElementById('toggleSolutionsBtn').classList.add('hidden');
    document.getElementById('resetUnitTop').classList.add('hidden');
    
    if (typeof loadActivityLog === 'function') {
        loadActivityLog();
    }
    
    history.pushState({ view: 'activity-log' }, '', '#activity-log');
}

// ==========================================
// ุนุฑุถ ุตูุญุฉ ุงููุณุฎ ุงูุงุญุชูุงุทู
// ==========================================
function showBackupManagement() {
    if (!checkAndUpdateUI()) {
        showLoginModal();
        return;
    }
    
    if (!checkPermission('canBackup')) {
        showToast('ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ุฅูู ุงููุณุฎ ุงูุงุญุชูุงุทู', 'error');
        return;
    }
    
    hideAllViews();
    
    appState.currentView = 'backup';

    const backupView = document.getElementById('backupManagementView');
    backupView.classList.remove('hidden');
    backupView.style.display = 'block';
    backupView.style.opacity = '1';
    backupView.style.visibility = 'visible';
    
    document.getElementById('mainHeader').classList.add('hidden');
    document.getElementById('fixedTopBar').classList.remove('hidden');
    document.body.style.paddingTop = "70px";
    document.getElementById('authorSignature').classList.add('hidden');
    
    document.getElementById('unitTitleTop').textContent = 'ุงููุณุฎ ุงูุงุญุชูุงุทู ููุฃุณุฆูุฉ';
    
    // โ ุฅุฎูุงุก ุงูุฃุฒุฑุงุฑ ุงููุทููุจุฉ ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
    document.getElementById('toggleFavoritesSmartDropdown').classList.add('hidden');
    document.getElementById('toggleSolutionsBtn').classList.add('hidden');
    document.getElementById('resetUnitTop').classList.add('hidden');
    
    if (typeof initExportImport === 'function') {
        initExportImport();
    }
    
    history.pushState({ view: 'backup-management' }, '', '#backup-management');
}

// ==========================================
// ุฅุฏุงุฑุฉ ุงูููุถูุฉ
// ==========================================
function toggleFavorite(unitId, questionIndex) {
    if (!appState.favorites[unitId]) {
        appState.favorites[unitId] = new Set();
    }
    
    if (appState.favorites[unitId].has(questionIndex)) {
        appState.favorites[unitId].delete(questionIndex);
        if (appState.favorites[unitId].size === 0) {
            delete appState.favorites[unitId];
        }
    } else {
        appState.favorites[unitId].add(questionIndex);
    }
    
    saveStorageData();
    updateFavoriteUI(unitId);
    return appState.favorites[unitId] && appState.favorites[unitId].has(questionIndex);
}

function isFavorite(unitId, questionIndex) {
    return appState.favorites[unitId] && appState.favorites[unitId].has(questionIndex);
}

function getFavoritesCount(unitId) {
    return appState.favorites[unitId] ? appState.favorites[unitId].size : 0;
}

function updateFavoriteUI(unitId) {
    const favoritesToggleText = document.getElementById('favoritesToggleText');
    if (favoritesToggleText && appState.currentUnit) {
        const favCount = getFavoritesCount(appState.currentUnit.id.toString());
        favoritesToggleText.textContent = `ุนุฑุถ ุงูุฃุณุฆูุฉ ุงูููุถูุฉ (${favCount})`;
    }
    
    document.querySelectorAll('.favorite-btn').forEach(btn => {
        const btnUnitId = btn.dataset.unitId;
        const btnQuestionIndex = parseInt(btn.dataset.questionIndex);
        
        if (btnUnitId && btnQuestionIndex !== undefined) {
            if (isFavorite(btnUnitId, btnQuestionIndex)) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fas fa-star"></i>';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="far fa-star"></i>';
            }
        }
    });
}

// ==========================================
// ุฅุฏุงุฑุฉ ุงููุงุฌูุฉ
// ==========================================
function updateQuestionFrame(qIndex, isCorrect, wasCorrected = false, isActive = false, isFavorite = false) {
    const qCard = document.getElementById(`q-${qIndex}`);
    if (!qCard) return;
    
    const originalIndex = appState.currentUnit.filteredQuestions[qIndex]?.originalIndex ?? qIndex;
    const answeredObj = appState.userAnswers[appState.currentUnit.id]?.[originalIndex];
    const isAnswered = answeredObj !== undefined && answeredObj !== null;
    
    qCard.classList.remove('frame-red', 'frame-green', 'frame-yellow', 'frame-blue', 'frame-purple', 'frame-neutral');
    
    if (isFavorite) {
        qCard.classList.add('frame-purple');
    } else if (appState.solutionsVisible) {
        qCard.classList.add('frame-green');
    } else if (isAnswered) {
        const correct = answeredObj.correct;
        const wasCorrectedAnswer = answeredObj.wasCorrected || false;
        
        if (wasCorrectedAnswer) {
            qCard.classList.add('frame-yellow');
        } else if (correct) {
            qCard.classList.add('frame-green');
        } else {
            qCard.classList.add('frame-red');
        }
    } else if (isActive) {
        qCard.classList.add('frame-blue');
    } else {
        qCard.classList.add('frame-neutral');
    }
}

// ==========================================
// ุฏูุงู Firebase ูููุฒุงููุฉ
// ==========================================
function syncDataToFirebase() {
    if (!appState.currentUser || !appState.firebaseUser) {
        showToast('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ูููุฒุงููุฉ', 'error');
        showLoginModal();
        return;
    }
    
    if (appState.isSyncing) return;

    appState.isSyncing = true;
    updateFirebaseStatus('ุฌุงุฑู ุงููุฒุงููุฉ...', 'blue');

    const userId = appState.firebaseUser.uid;
    const userData = {
        answers: appState.userAnswers,
        favorites: Object.fromEntries(
            Object.entries(appState.favorites).map(([key, set]) => [key, [...set]])
        ),
        lastSync: new Date().toISOString(),
        stats: getGlobalStats(),
        userInfo: {
            displayName: appState.currentUser?.name,
            email: appState.firebaseUser.email
        }
    };

    database.ref(`${USERS_PATH}/${userId}`).set(userData)
        .then(() => {
            appState.lastSyncTime = new Date();
            updateFirebaseStatus('ุชูุช ุงููุฒุงููุฉ ุจูุฌุงุญ', 'green');
            showToast('ุชู ุญูุธ ุจูุงูุงุชู ุนูู ุงูุณุญุงุจุฉ ุจูุฌุงุญ', 'success');
            
            setTimeout(() => {
                updateFirebaseStatus('ูุชุตู', 'gray');
            }, 3000);
        })
        .catch((error) => {
            console.error('ุฎุทุฃ ูู ุงููุฒุงููุฉ:', error);
            updateFirebaseStatus('ุฎุทุฃ ูู ุงููุฒุงููุฉ', 'red');
            showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงูุจูุงูุงุช ุนูู ุงูุณุญุงุจุฉ', 'error');
        })
        .finally(() => {
            appState.isSyncing = false;
        });
}

function loadDataFromFirebase() {
    if (!appState.firebaseUser) return;

    appState.isSyncing = true;
    updateFirebaseStatus('ุฌุงุฑู ุงูุชุญููู...', 'blue');

    const userId = appState.firebaseUser.uid;
    
    database.ref(`${USERS_PATH}/${userId}`).once('value')
        .then((snapshot) => {
            const data = snapshot.val();
            if (data) {
                if (data.answers) {
                    appState.userAnswers = data.answers;
                    localStorage.setItem(STORAGE_KEYS.ANSWERS, JSON.stringify(data.answers));
                }

                if (data.favorites) {
                    appState.favorites = {};
                    Object.entries(data.favorites).forEach(([unitId, favArray]) => {
                        appState.favorites[unitId] = new Set(favArray);
                    });
                    const favObject = Object.fromEntries(
                        Object.entries(appState.favorites).map(([key, set]) => [key, [...set]])
                    );
                    localStorage.setItem(STORAGE_KEYS.FAVORITES, JSON.stringify(favObject));
                }

                updateOverallStats();
                
                if (document.getElementById('unitsView') && !document.getElementById('unitsView').classList.contains('hidden')) {
                    renderUnits();
                }

                appState.lastSyncTime = data.lastSync ? new Date(data.lastSync) : null;
                updateFirebaseStatus('ุชู ุชุญููู ุจูุงูุงุชู', 'green');
                showToast('ุชู ุชุญููู ุจูุงูุงุชู ูู ุงูุณุญุงุจุฉ ุจูุฌุงุญ', 'success');
                
                setTimeout(() => {
                    updateFirebaseStatus('ูุชุตู', 'gray');
                }, 3000);
            } else {
                updateFirebaseStatus('ูุง ุชูุฌุฏ ุจูุงูุงุช', 'gray');
            }
        })
        .catch((error) => {
            console.error('ุฎุทุฃ ูู ุชุญููู ุงูุจูุงูุงุช:', error);
            updateFirebaseStatus('ุฎุทุฃ ูู ุงูุชุญููู', 'red');
            showToast('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูุจูุงูุงุช ูู ุงูุณุญุงุจุฉ', 'error');
        })
        .finally(() => {
            appState.isSyncing = false;
        });
}

function updateFirebaseStatus(text, color = 'gray') {
    const statusElement = document.getElementById('firebaseStatus');
    const syncStatusElement = document.getElementById('syncStatus');
    
    if (statusElement && syncStatusElement) {
        statusElement.classList.remove('hidden');
        syncStatusElement.textContent = text;
        
        statusElement.classList.remove('text-gray-500', 'text-green-500', 'text-red-500', 'text-blue-500');
        
        switch(color) {
            case 'green':
                statusElement.classList.add('text-green-500');
                break;
            case 'red':
                statusElement.classList.add('text-red-500');
                break;
            case 'blue':
                statusElement.classList.add('text-blue-500');
                break;
            default:
                statusElement.classList.add('text-gray-500');
        }
    }
}

function getGlobalStats() {
    let totalQ = 0, totalCorrect = 0, totalIncorrect = 0;
    
    unitsData.forEach(unit => {
        if (unit.type === 'qa-display') return;
        totalQ += unit.questions.length;
        const answers = appState.userAnswers[unit.id] || {};
        Object.values(answers).forEach(a => { 
            if (a?.correct === true) totalCorrect++; 
            else if (a?.correct === false) totalIncorrect++; 
        });
    });
    
    const totalAnswered = totalCorrect + totalIncorrect;
    const successRate = totalAnswered ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
    
    return {
        totalQuestions: totalQ,
        correctAnswers: totalCorrect,
        incorrectAnswers: totalIncorrect,
        successRate: successRate,
        lastUpdated: new Date().toISOString()
    };
}

// ==========================================
// ูุธุงู ุงูุฃุณุฆูุฉ ุงูุนุงูุฉ
// ==========================================
async function loadQuestionsFromFirebase() {
    try {
        const snapshot = await database.ref(PUBLIC_QUESTIONS_PATH).once('value');
        const questionsData = snapshot.val();
        
        if (questionsData) {
            trueFalseQuestionsData = questionsData.trueFalse || trueFalseQuestionsData;
            mcqQuestionsData = questionsData.mcq || mcqQuestionsData;
            multiSelectQuestionsData = questionsData.multiSelect || multiSelectQuestionsData;
            qaQuestionsData = questionsData.qa || qaQuestionsData;
            
            updateUnitsDataFromFirebase();
            return true;
        } else {
            return false;
        }
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุชุญููู ุงูุฃุณุฆูุฉ ูู Firebase:', error);
        showToast('ุชุนุฐุฑ ุชุญููู ุงูุฃุณุฆูุฉ ูู ุงูุณุญุงุจุฉุ ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ', 'warning');
        return false;
    }
}

async function saveQuestionsToFirebase() {
    try {
        const questionsData = {
            trueFalse: trueFalseQuestionsData,
            mcq: mcqQuestionsData,
            multiSelect: multiSelectQuestionsData,
            qa: qaQuestionsData,
            lastUpdated: new Date().toISOString(),
            updatedBy: appState.currentUser?.id || 'anonymous',
            version: '1.0.0'
        };
        
        await database.ref(PUBLIC_QUESTIONS_PATH).set(questionsData);
        return true;
    } catch (error) {
        console.error('โ ุฎุทุฃ ูู ุญูุธ ุงูุฃุณุฆูุฉ ุฅูู Firebase:', error);
        showToast('ุชุนุฐุฑ ุญูุธ ุงูุฃุณุฆูุฉ ุนูู ุงูุณุญุงุจุฉ', 'error');
        return false;
    }
}

function updateUnitsDataFromFirebase() {
    unitsData[0].questions = trueFalseQuestionsData;
    unitsData[1].questions = mcqQuestionsData;
    unitsData[2].questions = multiSelectQuestionsData;
    unitsData[3].questions = qaQuestionsData;
}

function getUnitQuestions(unitType) {
    switch(unitType) {
        case 'mcq-single-tf':
            return trueFalseQuestionsData;
        case 'mcq-single':
            return mcqQuestionsData;
        case 'mcq-multi':
            return multiSelectQuestionsData;
        case 'qa-display':
            return qaQuestionsData;
        default:
            return [];
    }
}

function updateUnitQuestions(unitType, newQuestions) {
    switch(unitType) {
        case 'mcq-single-tf':
            trueFalseQuestionsData = newQuestions;
            break;
        case 'mcq-single':
            mcqQuestionsData = newQuestions;
            break;
        case 'mcq-multi':
            multiSelectQuestionsData = newQuestions;
            break;
        case 'qa-display':
            qaQuestionsData = newQuestions;
            break;
    }
    
    const unitIndex = unitsData.findIndex(u => u.type === unitType);
    if (unitIndex !== -1) {
        unitsData[unitIndex].questions = newQuestions;
    }
}




function showBackupManagement() {
    if (!checkAndUpdateUI()) {
        showLoginModal();
        return;
    }
    
    if (!checkPermission('canBackup')) {
        showToast('ููุณ ูุฏูู ุตูุงุญูุฉ ูููุตูู ุฅูู ุงููุณุฎ ุงูุงุญุชูุงุทู', 'error');
        return;
    }
    
    hideAllViews();
    
    appState.currentView = 'backup';

    const backupView = document.getElementById('backupManagementView');
    backupView.classList.remove('hidden');
    backupView.style.display = 'block';
    backupView.style.opacity = '1';
    backupView.style.visibility = 'visible';
    
    document.getElementById('mainHeader').classList.add('hidden');
    document.getElementById('fixedTopBar').classList.remove('hidden');
    document.body.style.paddingTop = "70px";
    document.getElementById('authorSignature').classList.add('hidden');
    
    document.getElementById('unitTitleTop').textContent = 'ุงููุณุฎ ุงูุงุญุชูุงุทู ููุฃุณุฆูุฉ';
    
    // ุชููุฆุฉ ูุธุงู ุงูุชุตุฏูุฑ ูุงูุงุณุชูุฑุงุฏ
    if (typeof initExportImport === 'function') {
        initExportImport();
    }
    
    history.pushState({ view: 'backup-management' }, '', '#backup-management');
}

  
// ==========================================
// ุฏูุงู ุงููุณุงุนุฏุฉ ุงูุฅุถุงููุฉ
// ==========================================
function showToast(message, type = 'info') {
    const toastContainer = document.getElementById('toastContainer');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
    `;
    
    toastContainer.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 2000);
}

function checkAndUpdateUI() {
    if (!appState.currentUser) {
        if (appState.contentManagementMode || appState.currentView === 'users') {
            showUnitsView();
            showToast('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ูููุตูู ุฅูู ูุฐู ุงูุตูุญุฉ', 'error');
        }
        return false;
    }
    
    refreshUIForUserPermissions();
    return true;
}

// ==========================================
// ูุธุงู ุฅุฏุงุฑุฉ ุงููุญุชูู
// ==========================================
class ContentManager {
    constructor() {
        this.currentUnit = null;
        this.editingIndex = null;
    }

    handleAutoExpand(element) {
        if (!element) return;
        element.style.height = 'auto';
        element.style.height = (element.scrollHeight) + 'px';
    }

    openModal(unit, questionIndex = null) {
        if (!checkAndUpdateUI()) {
            showLoginModal();
            return;
        }
        
        if (!checkPermission('canEdit')) {
            showToast('ููุณ ูุฏูู ุตูุงุญูุฉ ูุชุนุฏูู ุงููุญุชูู', 'error');
            return;
        }

        this.currentUnit = unit;
        this.editingIndex = questionIndex;

        const modal = document.getElementById('contentManagementModal');
        const title = document.getElementById('contentModalTitle');
        const subtitle = document.getElementById('contentModalSubtitle');
        const formContainer = document.getElementById('contentFormContainer');
        const footerContainer = document.getElementById('contentModalFooter');

        const isEdit = questionIndex !== null;
        const question = isEdit ? unit.questions[questionIndex] : null;

        title.textContent = isEdit ? 'ุชุนุฏูู ุงููุญุชูู' : 'ุฅุถุงูุฉ ูุญุชูู ุฌุฏูุฏ';
        subtitle.textContent = unit.title || '';

        formContainer.innerHTML = this.buildContentForm(unit.type, question, isEdit);

        this.addModalCloseButton(title.parentElement);
        footerContainer.innerHTML = this.buildModalFooter(isEdit);

        this.attachModalEvents();

        modal.classList.add('active');

        setTimeout(() => {
            const firstInput = document.getElementById('contentQuestion') || 
                            document.getElementById('headerText') || 
                            document.getElementById('noteText');
            firstInput?.focus();
            
            document.querySelectorAll('#contentFormContainer textarea').forEach(tx => {
                this.handleAutoExpand(tx);
            });
        }, 150);
    }

    buildContentForm(type, question = null, isEdit = false) {
        switch(type) {
            case 'qa-display': return this.buildQAForm(question, isEdit);
            case 'mcq-single-tf': return this.buildTrueFalseForm(question, isEdit);
            case 'mcq-single': return this.buildMCQForm(question, isEdit, 'single');
            case 'mcq-multi': return this.buildMCQForm(question, isEdit, 'multi');
            default: return '<p class="p-4 text-center text-gray-500 dark:text-gray-400 text-sm">ููุน ุงูุณุคุงู ุบูุฑ ูุฏุนูู ุญุงููุงู</p>';
        }
    }

    buildQAForm(question, isEdit) {
        let currentType = isEdit ? (question.type || 'question') : 'question';
        return `
            <div class="space-y-3">
                <div class="mb-2">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ุงุฎุชุฑ ููุน ุงููุญุชูู:</label>
                    <div class="flex gap-1">
                        ${this.buildTypeSelector(currentType, isEdit, question)}
                    </div>
                </div>
                <div id="qaContentField" class="transition-all duration-200">
                    ${this.buildQAField(currentType, question, isEdit)}
                </div>
            </div>
        `;
    }

    buildTypeSelector(currentType, isEdit, question) {
        const types = [
            { value: 'question', label: 'ุณุคุงู', icon: 'fa-file-alt', color: 'blue' },
            { value: 'header', label: 'ุนููุงู', icon: 'fa-heading', color: 'green' },
            { value: 'note', label: 'ููุงุญุธุฉ', icon: 'fa-exclamation-circle', color: 'yellow' }
        ];
        
        return types.map(type => `
            <label class="flex-1 cursor-pointer">
                <input type="radio" name="qaType" value="${type.value}" 
                    ${currentType === type.value ? 'checked' : ''} 
                    class="sr-only peer" 
                    onchange="contentManager.updateQAField('${type.value}', ${isEdit ? 'true' : 'false'})">
                <div class="flex flex-col items-center gap-1 p-1.5 text-center rounded-lg transition-all duration-150
                            peer-checked:border-${type.color}-400 peer-checked:bg-${type.color}-50 dark:peer-checked:bg-${type.color}-900/30
                            border border-gray-200 dark:border-gray-700 hover:border-${type.color}-200">
                    <i class="fas ${type.icon} text-xs ${currentType === type.value ? `text-${type.color}-500` : 'text-gray-400'}"></i>
                    <span class="text-[10px] font-bold">${type.label}</span>
                </div>
            </label>
        `).join('');
    }

    buildQAField(type, question, isEdit) {
        if (type === 'header') return this.renderCompactInput('headerText', 'ูุต ุงูุนููุงู', question?.text || '', 'ูุซุงู: ููุฏูุฉ...', true);
        if (type === 'note') return this.renderCompactTextarea('noteText', 'ูุต ุงูููุงุญุธุฉ', question?.text || '', 'ุงูุชุจ ููุงุญุธุชู...', true);
        
        return `
            <div class="space-y-2">
                ${this.renderCompactTextarea('contentQuestion', 'ูุต ุงูุณุคุงู', question?.question || '', 'ุฃุฏุฎู ุงูุณุคุงู...', true, 'min-h-[60px]', true)}
                ${this.renderCompactTextarea('contentAnswer', 'ุงูุฅุฌุงุจุฉ ุงููููุฐุฌูุฉ', question?.answer || '', 'ุฃุฏุฎู ุงูุฅุฌุงุจุฉ...', true, 'min-h-[80px]', true)}
                <div class="grid grid-cols-2 gap-2">
                    ${this.renderCompactInput('contentSection', 'ุงููุณู', question?.section || '', 'ุงูููู', false, 'text-sm')}
                    ${this.renderCompactInput('contentPage', 'ุงูุตูุญุฉ', question?.page || '', '125', false, 'text-sm')}
                </div>
            </div>
        `;
    }

    buildMCQForm(question, isEdit, answerType) {
        const isMulti = answerType === 'multi';
        return `
            <div class="space-y-2">
                ${this.renderCompactTextarea('contentQuestion', 'ูุต ุงูุณุคุงู', question?.question || '', 'ุฃุฏุฎู ุงูุณุคุงู...', true, 'min-h-[60px]', true)}
                
                <div class="space-y-1.5">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-xs font-bold text-gray-500">ุงูุฎูุงุฑุงุช ุงููุชุงุญุฉ</span>
                        <button type="button" onclick="contentManager.addOption()" class="text-[10px] bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded transition-colors flex items-center gap-0.5">
                            <i class="fas fa-plus text-[9px]"></i> ุฅุถุงูุฉ
                        </button>
                    </div>
                    
                    <div id="optionsContainer" class="w-full space-y-1.5">
                        ${this.buildOptionsHTML(question, isEdit)}
                    </div>
                    
                    <div id="correctAnswerError" class="validation-error hidden text-red-500 text-[10px] mt-0.5 font-bold"></div>
                </div>

                ${this.renderCompactTextarea('contentExplanation', 'ุดุฑุญ ุงูุฅุฌุงุจุฉ', question?.explanation || '', 'ููุงุฐุง ูุฐู ุงูุฅุฌุงุจุฉุ', false, 'min-h-[60px]', true)}
                ${this.renderCompactInput('contentPage', 'ุฑูู ุงูุตูุญุฉ', question?.page || '', '44', false, 'text-sm')}
            </div>
        `;
    }

    buildOptionsHTML(question, isEdit) {
        const options = (isEdit && question.options) ? question.options : ['','', '', ''];
        const isMulti = this.currentUnit.type === 'mcq-multi';
        const correctIndices = isEdit ? (isMulti ? (question.answers || []) : [question.answerIndex]) : [];

        return options.map((opt, idx) => `
            <div class="flex items-center gap-1.5 w-full">
                <div class="flex-shrink-0 mt-1.5">
                    <input type="${isMulti ? 'checkbox' : 'radio'}" 
                        name="correctAnswer" 
                        value="${idx}" 
                        ${correctIndices.includes(idx) ? 'checked' : ''}
                        class="w-4 h-4 cursor-pointer accent-green-500">
                </div>
                <div class="flex-grow min-w-0">
                    <textarea 
                        class="w-full px-3 py-2.5 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-1 focus:ring-blue-400 focus:border-transparent focus:bg-white dark:focus:bg-gray-800 transition-all resize-none text-[14px] leading-relaxed min-h-[50px] placeholder:text-gray-400 placeholder:text-[12px]"
                        placeholder="ุงูุชุจ ูุต ุงูุฎูุงุฑ..."
                        oninput="contentManager.handleAutoExpand(this)"
                        data-option-idx="${idx}">${opt}</textarea>
                    <div id="optionError-${idx}" class="validation-error hidden text-red-500 text-[10px] mt-0.5"></div>
                </div>
                ${idx >= 2 ? `
                    <button type="button" onclick="contentManager.removeOption(this)" 
                            class="flex-shrink-0 text-gray-300 hover:text-red-500 transition-colors bg-transparent border-0 p-0.5">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                ` : '<div class="w-6 flex-shrink-0"></div>'}
            </div>
        `).join('');
    }

    buildTrueFalseForm(question, isEdit) {
        const answer = isEdit ? question.answerIndex : 0;
        return `
            <div class="space-y-2">
                ${this.renderCompactTextarea('contentQuestion', 'ูุต ุงูุนุจุงุฑุฉ', question?.question || '', 'ุฃุฏุฎู ุงูุนุจุงุฑุฉ...', true, 'min-h-[60px]', true)}
                
                <div class="flex gap-1.5">
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="contentAnswer" value="0" ${answer === 0 ? 'checked' : ''} class="sr-only peer">
                        <div class="p-1.5 text-center rounded-lg border border-gray-200 dark:border-gray-700 transition-all peer-checked:border-green-400 peer-checked:bg-green-50 dark:peer-checked:bg-green-900/30 hover:border-green-300">
                            <span class="text-sm font-bold text-gray-700 dark:text-gray-300">ุตุญ</span>
                        </div>
                    </label>
                    <label class="flex-1 cursor-pointer">
                        <input type="radio" name="contentAnswer" value="1" ${answer === 1 ? 'checked' : ''} class="sr-only peer">
                        <div class="p-1.5 text-center rounded-lg border border-gray-200 dark:border-gray-700 transition-all peer-checked:border-red-400 peer-checked:bg-red-50 dark:peer-checked:bg-red-900/30 hover:border-red-300">
                            <span class="text-sm font-bold text-gray-700 dark:text-gray-300">ุฎุทุฃ</span>
                        </div>
                    </label>
                </div>

                ${this.renderCompactTextarea('contentExplanation', 'ุงูุชูุณูุฑ', question?.explanation || '', 'ุชูุถูุญ...', false, 'min-h-[60px]', true)}
                ${this.renderCompactInput('contentPage', 'ุฑูู ุงูุตูุญุฉ', question?.page || '', '89', false, 'text-sm')}
            </div>
        `;
    }

    renderCompactTextarea(id, label, value, placeholder, required = false, extraClass = 'min-h-[50px]', largerText = false) {
        const textSize = largerText ? 'text-[14px]' : 'text-xs';
        const placeholderSize = largerText ? 'placeholder:text-[12px]' : 'placeholder:text-xs';
        
        return `
            <div class="w-full">
                <label class="block text-xs font-bold text-gray-500 mb-0.5">${label} ${required ? '*' : ''}</label>
                <textarea id="${id}" 
                    class="w-full px-3 py-2.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:border-blue-400 focus:ring-1 focus:ring-blue-400/20 transition-all outline-none ${textSize} leading-relaxed placeholder:text-gray-400 ${placeholderSize} resize-none ${extraClass}"
                    placeholder="${placeholder}"
                    oninput="contentManager.handleAutoExpand(this); validator.highlightField(this, this.value.trim().length > 0)">${value}</textarea>
                <div id="${id}Error" class="validation-error hidden text-red-500 text-[10px] mt-0.5 font-medium"></div>
            </div>
        `;
    }

    renderCompactInput(id, label, value, placeholder, required = false, textSize = 'text-sm') {
        return `
            <div class="w-full">
                <label class="block text-xs font-bold text-gray-500 mb-0.5">${label} ${required ? '*' : ''}</label>
                <input type="text" id="${id}" value="${value}"
                    class="w-full px-2.5 py-1.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:border-blue-400 focus:ring-1 focus:ring-blue-400/20 transition-all outline-none ${textSize} placeholder:text-gray-400"
                    placeholder="${placeholder}"
                    oninput="validator.highlightField(this, this.value.trim().length > 0)">
                <div id="${id}Error" class="validation-error hidden text-red-500 text-[10px] mt-0.5 font-medium"></div>
            </div>
        `;
    }

    addOption() {
        const container = document.getElementById('optionsContainer');
        if (container.children.length >= 4) {
            showMessage('ุงูุญุฏ ุงูุฃูุตู ููุฎูุงุฑุงุช ูู 4', 'warning');
            return;
        }
        
        const isMulti = this.currentUnit.type === 'mcq-multi';
        const newIdx = container.children.length;
        
        const optionHTML = `
            <div class="flex items-center gap-1.5 w-full">
                <div class="flex-shrink-0 mt-1.5">
                    <input type="${isMulti ? 'checkbox' : 'radio'}" name="correctAnswer" value="${newIdx}" class="w-4 h-4 cursor-pointer accent-green-500">
                </div>
                <div class="flex-grow min-w-0">
                    <textarea class="w-full px-3 py-2.5 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg focus:ring-1 focus:ring-blue-400 focus:bg-white dark:focus:bg-gray-800 transition-all resize-none text-[14px] leading-relaxed min-h-[50px] placeholder:text-gray-400 placeholder:text-[12px]"
                        placeholder="ุงูุชุจ ูุต ุงูุฎูุงุฑ..."
                        oninput="contentManager.handleAutoExpand(this)"
                        data-option-idx="${newIdx}"></textarea>
                    <div id="optionError-${newIdx}" class="validation-error hidden text-red-500 text-[10px] mt-0.5"></div>
                </div>
                <button type="button" onclick="contentManager.removeOption(this)" 
                        class="flex-shrink-0 text-gray-300 hover:text-red-500 transition-colors bg-transparent border-0 p-0.5">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', optionHTML);
        const textarea = container.lastElementChild.querySelector('textarea');
        textarea.focus();
        this.handleAutoExpand(textarea);
    }

    removeOption(btn) {
        const container = document.getElementById('optionsContainer');
        if (container.children.length <= 2) {
            showMessage('ูุฌุจ ุชููุฑ ุฎูุงุฑูู ุนูู ุงูุฃูู', 'warning');
            return;
        }
        btn.closest('.flex').remove();
        this.renumberOptions();
    }

    renumberOptions() {
        const container = document.getElementById('optionsContainer');
        container.querySelectorAll('.flex').forEach((row, idx) => {
            const input = row.querySelector('input[name="correctAnswer"]');
            const textarea = row.querySelector('textarea');
            const error = row.querySelector('.validation-error');
            
            if (input) input.value = idx;
            if (textarea) textarea.dataset.optionIdx = idx;
            if (error) error.id = `optionError-${idx}`;
        });
    }

    updateQAField(type, isEdit) {
        const container = document.getElementById('qaContentField');
        container.innerHTML = this.buildQAField(type, null, isEdit);
        setTimeout(() => {
            document.querySelectorAll('#qaContentField textarea').forEach(tx => this.handleAutoExpand(tx));
        }, 50);
    }

    async saveQuestion() {
        const unit = this.currentUnit;
        if (!this.validateForm(unit.type)) {
            showMessage('ูุฑุฌู ุงูุชุฃูุฏ ูู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู ุงูุฅุฌุจุงุฑูุฉ', 'error');
            return;
        }

        const questionData = this.collectFormData(unit.type);
        if (!questionData) return;

        const questions = [...unit.questions];
        let oldQuestion = null;
        
        if (this.editingIndex !== null) {
            // ุญูุธ ูุณุฎุฉ ูู ุงูุจูุงูุงุช ุงููุฏููุฉ
            oldQuestion = questions[this.editingIndex];
            questions[this.editingIndex] = questionData;
        } else {
            questions.push(questionData);
        }

        updateUnitQuestions(unit.type, questions);
        
        const submitBtn = document.getElementById('submitContent');
        const originalHTML = submitBtn.innerHTML;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ุฌุงุฑู ุงูุญูุธ...';
            
            const success = await saveQuestionsToFirebase();
            
            if (success) {
                // ุชุณุฌูู ุงููุดุงุท
                const activityType = this.editingIndex !== null ? 'EDIT' : 'ADD';
                const questionIndex = this.editingIndex !== null ? this.editingIndex : questions.length - 1;
                
                if (activityType === 'EDIT' && oldQuestion) {
                    if (typeof activityLogger !== 'undefined' && activityLogger.logActivity) {
                        await activityLogger.logActivity('EDIT', {
                            unitId: unit.id,
                            unitTitle: unit.title,
                            questionIndex: questionIndex,
                            questionText: questionData.question || questionData.text || '',
                            oldData: oldQuestion,
                            newData: questionData
                        });
                    }
                } else {
                    if (typeof activityLogger !== 'undefined' && activityLogger.logActivity) {
                        await activityLogger.logActivity('ADD', {
                            unitId: unit.id,
                            unitTitle: unit.title,
                            questionIndex: questionIndex,
                            questionText: questionData.question || questionData.text || '',
                            newData: questionData
                        });
                    }
                }
                
                showMessage('ุชู ุงูุญูุธ ุจูุฌุงุญ!', 'success');
                renderContentManagement(unit);
                if (this.editingIndex !== null) {
                    this.closeModal();
                } else {
                    this.resetForm();
                    document.getElementById('contentQuestion')?.focus();
                }
            }
        } catch (e) {
            console.error('ุฎุทุฃ ูู ุญูุธ ุงูุณุคุงู:', e);
            showMessage('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalHTML;
        }
    }

    validateForm(type) {
        let isValid = true;
        
        const fields = ['contentQuestion', 'contentAnswer', 'headerText', 'noteText'];
        fields.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                const isFieldValid = el.value.trim().length > 0;
                if (!isFieldValid) isValid = false;
                const errorEl = document.getElementById(`${id}Error`);
                if (errorEl) {
                    errorEl.textContent = isFieldValid ? '' : 'ูุฐุง ุงูุญูู ูุทููุจ';
                    errorEl.classList.toggle('hidden', isFieldValid);
                }
            }
        });

        if (type === 'mcq-single' || type === 'mcq-multi') {
            const options = document.querySelectorAll('#optionsContainer textarea');
            options.forEach((opt, idx) => {
                const isOptValid = opt.value.trim().length > 0;
                if (!isOptValid) isValid = false;
                const optError = document.getElementById(`optionError-${idx}`);
                if (optError) {
                    optError.textContent = isOptValid ? '' : 'ูุทููุจ';
                    optError.classList.toggle('hidden', isOptValid);
                }
            });

            const checked = document.querySelectorAll('input[name="correctAnswer"]:checked');
            const ansError = document.getElementById('correctAnswerError');
            const minSelected = (type === 'mcq-multi') ? 1 : 1;
            
            if (checked.length < minSelected) {
                isValid = false;
                if (ansError) {
                    ansError.textContent = `ูุฑุฌู ุงุฎุชูุงุฑ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ`;
                    ansError.classList.remove('hidden');
                }
            } else {
                ansError?.classList.add('hidden');
            }
        }
        return isValid;
    }

    collectFormData(type) {
        const question = document.getElementById('contentQuestion')?.value.trim();
        const page = document.getElementById('contentPage')?.value.trim();
        const explanation = document.getElementById('contentExplanation')?.value.trim();

        if (type === 'qa-display') {
            const qaType = document.querySelector('input[name="qaType"]:checked')?.value || 'question';
            if (qaType === 'header') return { type: 'header', text: document.getElementById('headerText').value.trim() };
            if (qaType === 'note') return { type: 'note', text: document.getElementById('noteText').value.trim() };
            return {
                type: 'qa',
                question,
                answer: document.getElementById('contentAnswer').value.trim(),
                section: document.getElementById('contentSection')?.value.trim(),
                page
            };
        }

        if (type === 'mcq-single-tf') {
            return {
                type: 'mcq-single-tf',
                question,
                options: ["ุตุญ", "ุฎุทุฃ"],
                answerIndex: parseInt(document.querySelector('input[name="contentAnswer"]:checked')?.value || 0),
                explanation,
                page
            };
        }

        const options = Array.from(document.querySelectorAll('#optionsContainer textarea')).map(t => t.value.trim());
        
        if (type === 'mcq-single') {
            return {
                type: 'mcq-single',
                question,
                options,
                answerIndex: parseInt(document.querySelector('input[name="correctAnswer"]:checked')?.value || 0),
                explanation,
                page
            };
        }

        if (type === 'mcq-multi') {
            const answers = Array.from(document.querySelectorAll('input[name="correctAnswer"]:checked')).map(i => parseInt(i.value));
            return {
                type: 'mcq-multi',
                question,
                options,
                answers: answers.sort((a,b) => a-b),
                explanation,
                page
            };
        }
    }

    closeModal() {
        const modal = document.getElementById('contentManagementModal');
        if (modal) {
            modal.classList.remove('active');
        }
        this.editingIndex = null;
    }

    resetForm() {
        const fieldsToClear = [
            'contentQuestion', 'contentAnswer', 'headerText', 
            'noteText', 'contentExplanation', 'contentSection', 'contentPage'
        ];
        
        fieldsToClear.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = '';
        });

        document.querySelectorAll('#optionsContainer textarea').forEach(t => t.value = '');
        
        document.querySelectorAll('input[name="correctAnswer"], input[name="contentAnswer"]').forEach(i => i.checked = false);

        const defaultType = document.querySelector('input[name="qaType"][value="question"]');
        if (defaultType) defaultType.checked = true;

        document.querySelectorAll('.validation-error').forEach(err => {
            err.textContent = '';
            err.classList.add('hidden');
        });
        
        document.querySelectorAll('textarea, input').forEach(el => {
            el.classList.remove('border-red-500', 'border-green-500');
            if (el.tagName === 'TEXTAREA') this.handleAutoExpand(el);
        });

        this.editingIndex = null;
    }

    addModalCloseButton(header) {
        if (header.querySelector('#topCloseModal')) return;
        header.style.position = 'relative';
        header.insertAdjacentHTML('beforeend', `
            <button id="topCloseModal" onclick="contentManager.closeModal()" class="absolute -top-1 -left-1 bg-red-100 text-red-600 w-7 h-7 rounded-full flex items-center justify-center hover:bg-red-600 hover:text-white transition-colors shadow-sm text-xs">
                <i class="fas fa-times"></i>
            </button>
        `);
    }

    buildModalFooter(isEdit) {
        return `
            <div class="flex gap-2 w-full mt-3">
                <button id="submitContent" class="flex-[2] py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow transition-all flex items-center justify-center gap-1.5 text-xs">
                    <i class="fas fa-cloud-upload-alt text-xs"></i>
                    ${isEdit ? 'ุชุญุฏูุซ' : 'ุญูุธ'}
                </button>
                <button onclick="contentManager.closeModal()" class="flex-1 py-2.5 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-lg font-bold hover:bg-gray-200 dark:hover:bg-gray-600 transition-all text-xs">
                    ุฅูุบุงุก
                </button>
            </div>
        `;
    }

    attachModalEvents() {
        const submitBtn = document.getElementById('submitContent');
        if (submitBtn) {
            submitBtn.onclick = () => this.saveQuestion();
        }
    }
}

const contentManager = new ContentManager();

// ==========================================
// ูุธุงู ุงูุชุญูู ูู ุงูููุงุฐุฌ
// ==========================================
const validator = {
    highlightField: function(element, isValid) {
        if (!element) return;
        
        if (isValid) {
            element.classList.remove('border-red-500', 'border-2');
            element.classList.add('border-green-500');
            
            const errorId = element.id + 'Error';
            const errorEl = document.getElementById(errorId);
            if (errorEl) {
                errorEl.classList.add('hidden');
            }
        } else {
            element.classList.remove('border-green-500');
            element.classList.add('border-red-500', 'border-2');
        }
    },
    
    validateEmail: function(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    },
    
    validateRequired: function(value) {
        return value && value.trim().length > 0;
    },
    
    validateMinLength: function(value, minLength) {
        return value && value.trim().length >= minLength;
    },
    
    validateOptions: function(options) {
        if (!options || options.length < 2) {
            return { valid: false, message: 'ูุฌุจ ุฅุถุงูุฉ ุฎูุงุฑูู ุนูู ุงูุฃูู' };
        }
        
        for (let i = 0; i < options.length; i++) {
            if (!options[i] || options[i].trim().length === 0) {
                return { valid: false, message: `ุงูุฎูุงุฑ ${i + 1} ูุง ูููู ุฃู ูููู ูุงุฑุบุงู` };
            }
        }
        
        return { valid: true, message: '' };
    }
};

function showMessage(message, type = 'info') {
    showToast(message, type);
}

// ==========================================
// ุฏูุงู ุงูุนุฑุถ ุงูููุญุฏุฉ (ุชู ุชุญุฏูุซูุง)
// ==========================================
function renderContentManagement(unit) {
    const contentList = document.getElementById('contentList');
    if (!contentList) return;
    
    contentList.innerHTML = '';
    
    updateQuestionsCounter(unit);
    
    const questions = unit.questions;
    
    if (!questions || questions.length === 0) {
        contentList.innerHTML = `
            <div class="text-center py-10">
                <div class="text-4xl mb-4">๐</div>
                <h3 class="text-xl font-bold mb-2">ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูู ูุฐู ุงููุญุฏุฉ</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">
                    ููููู ุฅุถุงูุฉ ุฃูู ุณุคุงู ุจุงุณุชุฎุฏุงู ุฒุฑ "ุฅุถุงูุฉ ุณุคุงู ุฌุฏูุฏ" ุฃุนูู ุงูุตูุญุฉ.
                </p>
            </div>
        `;
        return;
    }
    
    let questionCounter = 0;
    
    questions.forEach((item, index) => {
        if (unit.type === 'qa-display' && (item.type === 'header' || item.type === 'note')) {
            const card = createQAContentCard(unit, item, index);
            contentList.appendChild(card);
        } else {
            const card = createQuestionContentCard(unit, item, index, questionCounter);
            contentList.appendChild(card);
            questionCounter++;
        }
    });
    
    // ุชุญุฏูุซ ุงูุจุญุซ ุฅุฐุง ูุงู ูุดุทุงู
    if (typeof SearchManager !== 'undefined' && SearchManager.state.searchActive && SearchManager.state.currentSearchQuery) {
        SearchManager.updateSearchState(appState);
    }
}

function createQuestionContentCard(unit, item, index, displayIndex) {
    const isFav = isFavorite(unit.id.toString(), index);
    const isQAType = unit.type === 'qa-display';
    
    const card = document.createElement('div');
    card.className = `question-card bg-white dark:bg-gray-800 rounded-xl shadow p-5 border dark:border-gray-700 ${isFav ? 'favorite-card' : ''}`;
    card.id = `content-card-${index}`;
    
    let optionsHtml = '';
    let answerInfo = '';
    
    if (!isQAType) {
        optionsHtml = `<div class="mt-3 space-y-2">`;
        if (item.options && item.options.length > 0) {
            item.options.forEach((opt, optIdx) => {
                const isAnswer = unit.type === 'mcq-single-tf' || unit.type === 'mcq-single' ? 
                    optIdx === item.answerIndex : 
                    (item.answers?.includes(optIdx) || false);
                
                optionsHtml += `
                    <div class="flex items-center gap-2 p-2 border rounded ${isAnswer ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' : 'bg-gray-50 dark:bg-gray-800 border-gray-200 dark:border-gray-700'}">
                        <span class="w-6 h-6 flex items-center justify-center rounded-full ${isAnswer ? 'bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-300' : 'bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400'}">
                            ${optIdx + 1}
                        </span>
                        <span class="flex-1">${opt}</span>
                        ${isAnswer ? '<span class="text-green-600 dark:text-green-400">โ</span>' : ''}
                    </div>
                `;
            });
        }
        optionsHtml += `</div>`;
        
        if (unit.type === 'mcq-single-tf' || unit.type === 'mcq-single') {
            answerInfo = `ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ: ุงูุฎูุงุฑ ${item.answerIndex + 1}`;
        } else if (unit.type === 'mcq-multi') {
            answerInfo = `ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ: ${item.answers?.map(a => a + 1).join('ุ ')}`;
        }
    }
    
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    const canEdit = checkPermission('canEdit');
    const canDelete = checkPermission('canDelete');
    
    // ุจูุงุก ุฃุฒุฑุงุฑ ุงูุฅุฏุงุฑุฉ ุญุณุจ ุงูุตูุงุญูุงุช
    let adminButtonsHTML = '';
    if (canEdit) {
        adminButtonsHTML += `
            <button class="edit-btn action-btn flex items-center gap-2" 
                    onclick="contentManager.openModal(appState.currentContentUnit, ${index})">
                <i class="fas fa-edit"></i>
                ุชุนุฏูู
            </button>
        `;
    }
    
    if (canDelete) {
        adminButtonsHTML += `
            <button class="delete-btn action-btn flex items-center gap-2" 
                    onclick="deleteQuestion(appState.currentContentUnit, ${index})">
                <i class="fas fa-trash-alt"></i>
                ุญุฐู
            </button>
        `;
    }
    
    // ุฅุถุงูุฉ ุฃุฒุฑุงุฑ ุงูุฅุฏุงุฑุฉ ุฅุฐุง ูุงู ููุงู ุฃู ูููุง
    let adminSectionHTML = '';
    if (adminButtonsHTML) {
        adminSectionHTML = `
            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex gap-4">
                    ${adminButtonsHTML}
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                    ${new Date().toLocaleDateString('ar-SA')}
                </div>
            </div>
        `;
    }
    
    card.innerHTML = `
        <div class="mb-3">
            <div class="flex justify-between items-start mb-1">
                <div class="flex items-center">
                    <div class="text-sm text-gray-500 dark:text-gray-400">
                        ${isQAType ? 'ููููู' : 'ุณุคุงู'} ${displayIndex + 1}
                    </div>
                    ${canEdit ? `
                    <button class="favorite-btn mr-3 p-1 ${isFav ? 'active' : ''}" 
                            data-unit-id="${unit.id}" 
                            data-question-index="${index}" 
                            title="${isFav ? 'ุฅุฒุงูุฉ ูู ุงูููุถูุฉ' : 'ุฅุถุงูุฉ ููููุถูุฉ'}">
                        ${isFav ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>'}
                    </button>
                    ` : ''}
                </div>
                <div class="small-muted flex-shrink-0">ุตูุญุฉ:${item.page ? item.page : '-'}</div>
            </div>
            <h4 class="question-title mt-1 text-gray-800 dark:text-gray-200">
                ${item.question || item.text || ''}
            </h4>
            
            ${optionsHtml}
            
            ${item.answer ? `
            <div class="mt-3 p-3 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
                <div class="text-sm text-gray-800 dark:text-gray-300">${formatAnswerText(item.answer).innerHTML}</div>
            </div>` : ''}
            
            ${item.explanation ? `
            <div class="mt-3 p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                <div class="text-sm text-blue-800 dark:text-blue-300 font-semibold mb-1">ุงูุชูุณูุฑ:</div>
                <div class="text-sm text-blue-700 dark:text-blue-400">${item.explanation}</div>
            </div>` : ''}
            
            ${answerInfo ? `<div class="mt-2 text-sm text-green-600 dark:text-green-400 font-semibold">${answerInfo}</div>` : ''}
        </div>
        
        ${adminSectionHTML}
    `;
    
    if (canEdit) {
        const favoriteBtn = card.querySelector('.favorite-btn');
        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const unitId = this.dataset.unitId;
                const questionIndex = parseInt(this.dataset.questionIndex);
                const wasAdded = toggleFavorite(unitId, questionIndex);
                this.classList.toggle('active', wasAdded);
                this.innerHTML = wasAdded ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>';
                card.classList.toggle('favorite-card', wasAdded);
            });
        }
    }
    
    return card;
}

function createQAContentCard(unit, item, index) {
    const card = document.createElement('div');
    
    // ุงูุชุญูู ูู ุงูุตูุงุญูุงุช
    const canEdit = checkPermission('canEdit');
    const canDelete = checkPermission('canDelete');
    
    if (item.type === 'header') {
        card.className = `question-card qa-header-card rounded-xl shadow p-5 mb-6`;
        
        let actionButtonsHTML = '';
        if (canEdit) {
            actionButtonsHTML += `
                <button class="edit-btn action-btn flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white border-0" 
                        onclick="contentManager.openModal(appState.currentContentUnit, ${index})">
                    <i class="fas fa-edit"></i>
                    ุชุนุฏูู ุงูุนููุงู
                </button>
            `;
        }
        
        if (canDelete) {
            actionButtonsHTML += `
                <button class="delete-btn action-btn flex items-center gap-2 bg-red-500/80 hover:bg-red-600/80 text-white border-0"
                        onclick="deleteQuestion(appState.currentContentUnit, ${index})">
                    <i class="fas fa-trash-alt"></i>
                    ุญุฐู ุงูุนููุงู
                </button>
            `;
        }
        
        card.innerHTML = `
            <div class="mb-4">
                <div class="flex justify-between items-start mb-1">
                    <h4 class="text-xl font-bold text-white flex items-center gap-2">
                        <i class="fas fa-folder"></i>
                        ${item.text}
                    </h4>
                    <div class="small-muted text-white/80">ุนููุงู ูุณู</div>
                </div>
            </div>
            
            ${actionButtonsHTML ? `
            <div class="qa-action-buttons">
                ${actionButtonsHTML}
            </div>
            ` : ''}
        `;
    } else if (item.type === 'note') {
        card.className = `question-card qa-note-card rounded-xl shadow p-5 mb-6`;
        
        let actionButtonsHTML = '';
        if (canEdit) {
            actionButtonsHTML += `
                <button class="edit-btn action-btn flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white border-0"
                        onclick="contentManager.openModal(appState.currentContentUnit, ${index})">
                    <i class="fas fa-edit"></i>
                    ุชุนุฏูู ุงูููุงุญุธุฉ
                </button>
            `;
        }
        
        if (canDelete) {
            actionButtonsHTML += `
                <button class="delete-btn action-btn flex items-center gap-2 bg-red-500/80 hover:bg-red-600/80 text-white border-0"
                        onclick="deleteQuestion(appState.currentContentUnit, ${index})">
                    <i class="fas fa-trash-alt"></i>
                    ุญุฐู ุงูููุงุญุธุฉ
                </button>
            `;
        }
        
        card.innerHTML = `
            <div class="mb-4">
                <div class="flex justify-between items-start mb-1">
                    <h4 class="text-lg font-bold text-white flex items-center gap-2">
                        <i class="fas fa-sticky-note"></i>
                        ููุงุญุธุฉ
                    </h4>
                    <div class="small-muted text-white/80">ููุงุญุธุฉ</div>
                </div>
                <p class="text-white/90 mt-2">${item.text}</p>
            </div>
            
            ${actionButtonsHTML ? `
            <div class="qa-action-buttons">
                ${actionButtonsHTML}
            </div>
            ` : ''}
        `;
    } else {
        return createQuestionContentCard(unit, item, index, 0);
    }
    
    return card;
}

function renderUnits() {
    const grid = document.getElementById('unitsGrid');
    grid.innerHTML = '';
    
    unitsData.forEach(unit => {
        const { answered, total, correct, percent: perc, mistakes, completion } = calculateUnitProgress(unit.id);
        const disabled = total === 0 && unit.type !== 'qa-display';
        const unitIcon = unit.icon || '๐';
        const favCount = getFavoritesCount(unit.id.toString());
        
        const card = document.createElement('div');
        card.className = `question-card bg-white dark:bg-gray-800 rounded-xl shadow p-5 border dark:border-gray-700 ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`;
        
        let actionButtons = '';
        
        if (unit.type === 'qa-display') {
            // ุฒุฑ ุฅุฏุงุฑุฉ ุงููุญุชูู (ูุธูุฑ ููุท ููู ูุฏููู ุตูุงุญูุฉ canAccessAdmin)
            let adminButton = '';
            if (checkPermission('canAccessAdmin')) {
                adminButton = `
                    <button data-unit-id="${unit.id}" class="admin-btn mt-3 px-4 py-1.5 rounded-lg text-sm font-semibold text-white border border-purple-300 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800">
                        ุฅุฏุงุฑุฉ ุงููุญุชูู ๐๏ธ
                    </button>
                `;
            }
            
            actionButtons = `
                <button data-unit-id="${unit.id}" data-mode="normal" class="unit-start-btn px-4 py-1.5 rounded-lg text-sm font-semibold text-primary border border-green-300 bg-green-50 hover:bg-green-100 dark:bg-green-900/40 dark:text-green-300 dark:border-green-700">
                    ุนุฑุถ ุงููุนูููุงุช โ
                </button>
                ${favCount > 0 ? `<button data-unit-id="${unit.id}" data-mode="favorites" class="favorites-btn mt-3 px-4 py-1.5 rounded-lg text-sm font-semibold text-yellow-700 border border-yellow-300 bg-yellow-50 hover:bg-yellow-100 dark:bg-yellow-900/40 dark:text-yellow-300 dark:border-yellow-700">ุนุฑุถ ุงูููุถูุฉ (${favCount}) โญ</button>` : ''}
                ${adminButton}
            `;
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div><h3 class="text-lg font-semibold ${disabled? 'text-gray-400':'text-primary'}">${unit.title}</h3>
                    <div class="mt-1 text-sm text-gray-600 dark:text-gray-400">${total} ุณุคุงู ูุฌูุงุจ ูููุฑุงุฌุนุฉ</div></div>
                    <div class="text-3xl">${unitIcon}</div>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2 mb-2"><div class="bg-primary h-2 rounded-full" style="width:100%"></div></div>
                <div class="flex gap-3 text-sm text-gray-600 dark:text-gray-400">ูุณู ูุฑุฌุนู ููููุงููู ุงูุฃุณุงุณูุฉ.</div>
                <div class="flex flex-col gap-2 mt-4">${actionButtons}</div>`;
        } else if (!disabled) {
            let startText = (completion === 'in-progress' ? 'ุงุณุชุฆูุงู ุงูุงุฎุชุจุงุฑ โถ๏ธ' : (completion === 'completed' ? 'ุฅุนุงุฏุฉ ุงูุงุฎุชุจุงุฑ ๐' : 'ุงุจุชุฏุงุก ุงูุงุฎุชุจุงุฑ ๐'));
            let reviewButton = mistakes > 0 ? `<button data-unit-id="${unit.id}" data-mode="practice" class="review-btn mt-3 px-4 py-1.5 rounded-lg text-sm font-semibold text-red-700 border border-red-300 bg-red-50 hover:bg-red-100 dark:bg-red-900/40 dark:text-red-300 dark:border-red-700">ูุฑุงุฌุนุฉ ุงูุฃุฎุทุงุก (${mistakes}) โ</button>` : '';
            let favoritesButton = favCount > 0 ? `<button data-unit-id="${unit.id}" data-mode="favorites" class="favorites-btn mt-3 px-4 py-1.5 rounded-lg text-sm font-semibold text-yellow-700 border border-yellow-300 bg-yellow-50 hover:bg-yellow-100 dark:bg-yellow-900/40 dark:text-yellow-300 dark:border-yellow-700">ุนุฑุถ ุงูููุถูุฉ (${favCount}) โญ</button>` : '';
            
            // ุฒุฑ ุฅุฏุงุฑุฉ ุงููุญุชูู (ูุธูุฑ ููุท ููู ูุฏููู ุตูุงุญูุฉ canAccessAdmin)
            let adminButton = '';
            if (checkPermission('canAccessAdmin')) {
                adminButton = `<button data-unit-id="${unit.id}" class="admin-btn mt-3 px-4 py-1.5 rounded-lg text-sm font-semibold text-white border border-purple-300 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800">
                    ุฅุฏุงุฑุฉ ุงููุญุชูู ๐๏ธ
                </button>`;
            }
            
            actionButtons = `
                <button data-unit-id="${unit.id}" data-mode="normal" class="unit-start-btn px-4 py-1.5 rounded-lg text-sm font-semibold text-primary border border-green-300 bg-green-50 hover:bg-green-100 dark:bg-green-900/40 dark:text-green-300 dark:border-green-700">${startText}</button>
                ${reviewButton}
                ${favoritesButton}
                ${adminButton}
            `;
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold ${disabled? 'text-gray-400':'text-primary'}">${unit.title}</h3>
                        <div class="mt-1 text-sm text-gray-600 dark:text-gray-400">${answered}/${total} ูุฌุงุจ ุนูููุง</div>
                    </div>
                    <div class="text-3xl">${unitIcon}</div>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2 mb-2">
                    <div class="bg-primary h-2 rounded-full" style="width:${perc}%"></div>
                </div>
                <div class="flex gap-3 text-sm">
                    <div class="text-green-600 dark:text-green-400 font-bold">${correct}</div>
                    <div class="text-gray-600 dark:text-gray-400">ุฅุฌุงุจุงุช ุตุญูุญุฉ</div>
                </div>
                <div class="flex gap-3 text-sm mt-2">
                    <div class="text-yellow-600 dark:text-yellow-400 font-bold">${favCount}</div>
                    <div class="text-gray-600 dark:text-gray-400">ุฃุณุฆูุฉ ููุถูุฉ</div>
                </div>
                <div class="flex flex-col gap-2 mt-4">${actionButtons}</div>`;
        } else {
            // ุฒุฑ ุฅุฏุงุฑุฉ ุงููุญุชูู (ูุธูุฑ ููุท ููู ูุฏููู ุตูุงุญูุฉ canAccessAdmin)
            let adminButton = '';
            if (checkPermission('canAccessAdmin')) {
                adminButton = `<button data-unit-id="${unit.id}" class="admin-btn px-4 py-1.5 rounded-lg text-sm font-semibold text-white border border-purple-300 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800">
                    ุฅุฏุงุฑุฉ ุงููุญุชูู ๐๏ธ
                </button>`;
            }
            
            actionButtons = adminButton;
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-semibold ${disabled? 'text-gray-400':'text-primary'}">${unit.title}</h3>
                        <div class="mt-1 text-sm text-gray-600 dark:text-gray-400">0/0 ูุฌุงุจ ุนูููุง</div>
                    </div>
                    <div class="text-3xl">${unitIcon}</div>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2 mb-2">
                    <div class="bg-primary h-2 rounded-full" style="width:0%"></div>
                </div>
                <div class="text-sm text-gray-500">ุงููุญุฏุฉ ููุฏ ุงูุฅุนุฏุงุฏ...</div>
                <div class="flex flex-col gap-2 mt-4">${actionButtons}</div>`;
        }
        
        if (!disabled) {
            card.querySelectorAll('.unit-start-btn, .review-btn, .favorites-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showUnitQuestions(unit, e.currentTarget.dataset.mode);
                });
            });
        }
        
        card.querySelectorAll('.admin-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const unitId = parseInt(e.currentTarget.dataset.unitId);
                const unit = unitsData.find(u => u.id === unitId);
                if (unit) {
                    showContentManagement(unit);
                }
            });
        });
        
        grid.appendChild(card);
    });
}

function renderQuestions(questions, type, tempAnswers = null) {
    const list = document.getElementById('questionsList');
    if (!list) return;
    
    list.innerHTML = '';
    
    if (!questions || questions.length === 0) {
        list.innerHTML = `
            <div class="text-center py-10">
                <div class="text-4xl mb-4">๐</div>
                <h3 class="text-xl font-bold mb-2">ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุนุฑุถูุง</h3>
                <p class="text-gray-600 dark:text-gray-400">
                    ${appState.currentUnit.mode === 'favorites' ? 'ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ููุถูุฉ ูู ูุฐู ุงููุญุฏุฉ.' : 'ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ูุชุงุญุฉ ุญุงููุงู.'}
                </p>
                <button onclick="showUnitQuestions(appState.currentUnit, 'normal')" 
                        class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    ุงูุนูุฏุฉ ูููุถุน ุงูุนุงุฏู
                </button>
            </div>
        `;
        return;
    }
    
    const permanentAnswers = appState.userAnswers[appState.currentUnit.id] || {};
    const unitAnswers = tempAnswers || permanentAnswers;
    
    questions.forEach((q, qIndex) => {
        const originalIndex = q.originalIndex !== undefined ? q.originalIndex : qIndex;
        const answeredObj = unitAnswers[originalIndex] || null;
        const isSuccessfullyAnswered = answeredObj && answeredObj.correct;
        const isLocked = appState.solutionsVisible || isSuccessfullyAnswered || 
                       (appState.currentUnit.mode === 'normal' && answeredObj !== null) || 
                       (tempAnswers !== null);
        const answeredClass = isLocked ? 'question-answered' : '';
        const isFav = isFavorite(appState.currentUnit.id.toString(), originalIndex);

        if (type === 'mcq-multi') {
            appState.multiSelectionState[qIndex] = appState.solutionsVisible ? q.answers : 
                (isLocked && tempAnswers === null ? answeredObj.selectedIndices || [] : 
                (tempAnswers ? (answeredObj.selectedIndices || []) : []));
        }

        const card = document.createElement('div');
        card.className = `question-card bg-white dark:bg-gray-800 rounded-xl shadow p-5 border dark:border-gray-700 ${answeredClass}`;
        card.setAttribute('id', `q-${qIndex}`);
        
        const isActive = (qIndex === appState.activeQuestionIndex);
        updateQuestionFrame(qIndex, isLocked ? true : answeredObj?.correct, answeredObj?.wasCorrected, isActive, isFav);
        
        const checkBtnClass = isLocked ? 'hidden' : 'check-multi-btn disabled';
        
        const gridClass = type === 'mcq-single-tf' ? 'grid-cols-2 gap-4' : 'grid-cols-1 gap-3';
        
        card.innerHTML = `
            <div class="mb-3">
                <div class="flex justify-between items-start mb-1">
                    <div class="flex items-center">
                        <div class="text-sm text-gray-500 dark:text-gray-400">ุณุคุงู ${originalIndex + 1} / ${appState.currentUnit.questions.length}</div>
                        <button class="favorite-btn mr-3 p-1 ${isFav ? 'active' : ''}" 
                                data-unit-id="${appState.currentUnit.id}" 
                                data-question-index="${originalIndex}" 
                                title="${isFav ? 'ุฅุฒุงูุฉ ูู ุงูููุถูุฉ' : 'ุฅุถุงูุฉ ููููุถูุฉ'}">
                            ${isFav ? '<i class="fas fa-star"></i>' : '<i class="far fa-star"></i>'}
                        </button>
                    </div>
                    <div class="small-muted flex-shrink-0">ุตูุญุฉ:${q.page ? q.page : '-'}</div>
                </div>
                <h4 class="question-title mt-1">${q.question}</h4>
            </div>
            <div id="optionsContainer-${qIndex}" class="options-grid grid ${gridClass}"></div>
            <div id="resultArea-${qIndex}" class="result-area mt-4"></div>
            ${type === 'mcq-multi' ? `<div class="mt-4 flex justify-end items-center">
                 <button id="checkBtn-${qIndex}" data-q="${qIndex}" class="px-5 py-2 btn-primary rounded-lg text-white text-md ${checkBtnClass}">
                    ุชุญูู ูู ุงูุฅุฌุงุจุฉ
                 </button>
            </div>` : ''}
        `;
        list.appendChild(card);
        if (type === 'mcq-multi') {
            const checkBtn = card.querySelector(`#checkBtn-${qIndex}`);
            if (checkBtn) {
                checkBtn.onclick = () => onMultiOptionCheckAndRender(qIndex);
            }
        }
        
        applyKaTeX(card.querySelector('h4'));
        const favoriteBtn = card.querySelector('.favorite-btn');
        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const unitId = this.dataset.unitId;
                const questionIndex = parseInt(this.dataset.questionIndex);
                const wasAdded = toggleFavorite(unitId, questionIndex);
                updateQuestionFrame(qIndex, isLocked ? true : answeredObj?.correct, answeredObj?.wasCorrected, isActive, wasAdded);
                if (appState.currentUnit.mode === 'favorites' && !wasAdded) {
                    setTimeout(() => { showUnitQuestions(unit, 'favorites'); }, 300);
                }
                updateToggleFavoritesButton();
            });
        }
        renderQuestionOptions(card.querySelector(`#optionsContainer-${qIndex}`), q, qIndex, isLocked, answeredObj);
        if (type === 'mcq-multi' && !isLocked) {
            const checkBtn = card.querySelector(`#checkBtn-${qIndex}`);
            if (checkBtn) { checkBtn.classList.add('disabled'); checkBtn.classList.remove('enabled'); }
        }
        if (isLocked) {
            const answerToShow = appState.solutionsVisible ? (type === 'mcq-multi' ? q.answers : q.answerIndex) : (answeredObj.answerIndex !== undefined ? answeredObj.answerIndex : answeredObj.selectedIndices);
            renderExplanation(card.querySelector(`#resultArea-${qIndex}`), q, appState.solutionsVisible ? true : answeredObj.correct, answerToShow, type);
        }
    });
    
    if (questions.length > 0) { setActiveQuestion(appState.activeQuestionIndex, 'instant'); }
    updateUnitProgress();
    
    // ุชูููุฒ ุงูุจุญุซ ุฅุฐุง ูุงู ูุดุทุงู
    if (typeof SearchManager !== 'undefined' && SearchManager.state.searchActive && SearchManager.state.currentSearchQuery) {
        SearchManager.highlightSearchTerms(appState);
    }
}

function renderQuestionOptions(optsContainer, q, qIndex, isLocked, answeredObj) {
    if (!optsContainer) return;
    
    const type = appState.currentUnit.type;
    const currentSelection = type === 'mcq-multi' ? (appState.multiSelectionState[qIndex] || []) : (answeredObj ? answeredObj.answerIndex : null);
    const correctAnswers = type === 'mcq-multi' ? q.answers : [q.answerIndex];
    optsContainer.innerHTML = '';

    q.options.forEach((optText, optIdx) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn flex items-start p-3 border rounded-lg text-right w-full border-gray-200 dark:border-gray-700 hover:border-indigo-400 dark:hover:border-indigo-500 transition-colors';
        btn.setAttribute('data-q', qIndex);
        btn.setAttribute('data-opt', optIdx);

        const isSelected = type === 'mcq-multi' ? currentSelection.includes(optIdx) : currentSelection === optIdx;
        let icon = '';
        
        if (isLocked) {
            const isCorrectOption = correctAnswers.includes(optIdx);
            if (isCorrectOption) {
                btn.classList.add('is-correct');
                if (isSelected || type === 'mcq-single-tf' || type === 'mcq-single') icon = 'โ';
            } else if (isSelected) {
                btn.classList.add('is-wrong');
                icon = 'โ';
            } else {
                btn.classList.add('faded');
            }
            btn.disabled = true;
        } else if (isSelected && type === 'mcq-multi') {
            btn.classList.add('multi-selected');
        }
        
        // ุงูุชุนุฏูู ููุง: ูุณุชุฎุฏู ุงูุชุฑููู (1, 2) ุฏุงุฆูุงู ุฅูุง ุฅุฐุง ูุงู ุงูููุน "ุตุญ ูุฎุทุฃ" ุตุฑูุญ
        const labelText = (type === 'mcq-single-tf') ? 
            (optIdx === 0 ? 'โ' : 'โ') : (optIdx + 1);

        btn.innerHTML = `<span class="option-label">${labelText}</span><span class="flex-1 text-base text-gray-800 dark:text-gray-200 flex justify-between items-center"><span>${optText}</span><span class="text-xl ml-2">${icon}</span></span>`;
        
        if (!isLocked) {
            if (type === 'mcq-multi') {
                btn.addEventListener('click', () => onMultiOptionSelect(qIndex, optIdx));
            } else if (type === 'mcq-single-tf' || type === 'mcq-single') {
                btn.addEventListener('click', () => onSingleOptionClick(qIndex, optIdx, 
                    appState.currentUnit.filteredQuestions[qIndex].originalIndex ?? qIndex,
                    appState.currentUnit.filteredQuestions[qIndex]));
            }
        }
        optsContainer.appendChild(btn);
        applyKaTeX(btn);
    });
}

function onSingleOptionClick(qIndex, optIdx, originalIndex, question) {
    const unitId = appState.currentUnit.id;
    const correct = optIdx === question.answerIndex;
    const previousAnswer = appState.userAnswers[unitId]?.[originalIndex];
    const wasCorrected = previousAnswer && !previousAnswer.correct && correct;
    
    if (!appState.userAnswers[unitId]) appState.userAnswers[unitId] = {};
    appState.userAnswers[unitId][originalIndex] = { 
        answerIndex: optIdx, 
        correct: correct,
        wasCorrected: wasCorrected || false,
        timestamp: Date.now() 
    };
    saveStorageData();

    const qCard = document.getElementById(`q-${qIndex}`);
    if (qCard) {
        renderExplanation(qCard.querySelector(`#resultArea-${qIndex}`), question, correct, optIdx, appState.currentUnit.type);
        
        const isFav = isFavorite(unitId.toString(), originalIndex);
        updateQuestionFrame(qIndex, correct, wasCorrected, (qIndex === appState.activeQuestionIndex), isFav);
        
        qCard.querySelectorAll('.option-btn').forEach(btn => {
            const cOpt = parseInt(btn.dataset.opt);
            btn.disabled = true;
            btn.classList.remove('is-correct', 'is-wrong', 'faded', 'multi-selected');
            
            if (cOpt === question.answerIndex) {
                btn.classList.add('is-correct');
            } else if (cOpt === optIdx) {
                btn.classList.add('is-wrong');
            } else {
                btn.classList.add('faded');
            }
        });
        
        qCard.classList.add('question-answered');
        
        setTimeout(() => {
            setActiveQuestion(qIndex, 'smooth');
        }, 50);

        updateUnitProgress();
        updateOverallStats();
        
        if (appState.currentUnit.mode === 'practice') {
            checkPracticeRoundStatus();
        } else if (calculateUnitProgress(unitId).answered === calculateUnitProgress(unitId).total) {
            showCompletionToast(unitId);
        }
    }
}

function onMultiOptionSelect(qIndex, optIdx) {
    const currentSelection = appState.multiSelectionState[qIndex] || [];
    const indexInSelection = currentSelection.indexOf(optIdx);
    
    if (indexInSelection > -1) {
        currentSelection.splice(indexInSelection, 1);
    } else {
        currentSelection.push(optIdx);
    }
    
    appState.multiSelectionState[qIndex] = currentSelection;

    const checkBtn = document.getElementById(`checkBtn-${qIndex}`);
    if (checkBtn) {
        if (currentSelection.length < 2) {
            checkBtn.classList.add('disabled');
            checkBtn.classList.remove('enabled');
            checkBtn.disabled = true;
        } else {
            checkBtn.classList.remove('disabled');
            checkBtn.classList.add('enabled');
            checkBtn.disabled = false;
        }
    }

    const optionsContainer = document.getElementById(`optionsContainer-${qIndex}`);
    if (optionsContainer) {
        renderQuestionOptions(optionsContainer, appState.currentUnit.filteredQuestions[qIndex], qIndex, false, null);
    }
}

function onMultiOptionCheckAndRender(qIndex) {
    const question = appState.currentUnit.filteredQuestions[qIndex];
    const originalIndex = question.originalIndex ?? qIndex;
    const selectedIndices = appState.multiSelectionState[qIndex] || [];
    
    if (selectedIndices.length < 2) {
        showMessage("โ๏ธ ูุฑุฌู ุงุฎุชูุงุฑ ุฎูุงุฑูู ุนูู ุงูุฃูู ููุชุญูู.", 'warning');
        return;
    }
    
    const isFullyCorrect = selectedIndices.length === question.answers.length && 
                           selectedIndices.every(idx => question.answers.includes(idx)) &&
                           question.answers.every(idx => selectedIndices.includes(idx));
    
    const previousAnswer = appState.userAnswers[appState.currentUnit.id]?.[originalIndex];
    const wasCorrected = previousAnswer && !previousAnswer.correct && isFullyCorrect;

    if (!appState.userAnswers[appState.currentUnit.id]) appState.userAnswers[appState.currentUnit.id] = {};
    appState.userAnswers[appState.currentUnit.id][originalIndex] = { 
        selectedIndices: [...selectedIndices],
        correct: isFullyCorrect,
        wasCorrected: wasCorrected || false,
        timestamp: Date.now() 
    };
    saveStorageData();

    const card = document.getElementById(`q-${qIndex}`);
    if (!card) return;
    
    const checkBtn = card.querySelector(`#checkBtn-${qIndex}`);
    
    if (checkBtn) {
        checkBtn.classList.add('hidden');
    }

    const isFav = isFavorite(appState.currentUnit.id.toString(), originalIndex);
    updateQuestionFrame(qIndex, isFullyCorrect, wasCorrected, (qIndex === appState.activeQuestionIndex), isFav);
    
    renderExplanation(card.querySelector(`#resultArea-${qIndex}`), question, isFullyCorrect, selectedIndices, appState.currentUnit.type);
    
    renderQuestionOptions(card.querySelector(`#optionsContainer-${qIndex}`), question, qIndex, true, { 
        correct: isFullyCorrect, 
        selectedIndices: [...selectedIndices] 
    });
    
    card.classList.add('question-answered');
    
    setTimeout(() => {
        setActiveQuestion(qIndex, 'smooth');
    }, 50);
    
    updateUnitProgress();
    updateOverallStats();
    
    if (appState.currentUnit.mode === 'practice') {
        checkPracticeRoundStatus();
    } else if (calculateUnitProgress(appState.currentUnit.id).answered === calculateUnitProgress(appState.currentUnit.id).total) {
        showCompletionToast(appState.currentUnit.id);
    }
}

function renderQAQuestions(unit, mode = 'normal') {
    const list = document.getElementById('questionsList');
    if (!list) return;
    
    list.innerHTML = '';
    
    let questionCounter = 1;
    let questionsToRender = unit.questions;
    
    if (mode === 'favorites') {
        const favSet = appState.favorites[unit.id] || new Set();
        questionsToRender = unit.questions.filter((item, index) => {
            if (item.type === 'header' || item.type === 'note') return false;
            return favSet.has(index);
        });
        
        if (questionsToRender.length === 0) {
            list.innerHTML = `
                <div class="text-center py-10">
                    <div class="text-4xl mb-4">โญ</div>
                    <h3 class="text-xl font-bold mb-2">ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ููุถูุฉ</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-4">
                        ูู ุชูู ุจุฅุถุงูุฉ ุฃู ุฃุณุฆูุฉ ููุงููุฉ ุฅูู ุงูููุถูุฉ ุจุนุฏ.
                    </p>
                    <button onclick="showUnitQuestions(appState.currentUnit, 'normal')" 
                            class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        ุงูุนูุฏุฉ ูููุถุน ุงูุนุงุฏู
                    </button>
                </div>
            `;
            return;
        }
    }
    
    let displayedCount = 0;
    
    unit.questions.forEach((item, index) => {
        if (mode === 'favorites') {
            const favSet = appState.favorites[unit.id] || new Set();
            if (item.type === 'header' || item.type === 'note' || !favSet.has(index)) {
                return;
            }
        }
        
        if (item.type === 'header') {
            const headerDiv = document.createElement('div');
            headerDiv.className = 'py-4 mt-8 mb-4 border-b-2 border-blue-600';
            headerDiv.innerHTML = `<h3 class="text-xl font-bold text-blue-800 dark:text-blue-400 flex items-center gap-2"><span>๐</span> ${item.text}</h3>`;
            list.appendChild(headerDiv);
            return;
        }

        if (item.type === 'note') {
            const noteDiv = document.createElement('div');
            noteDiv.className = 'my-4 p-4 bg-amber-50 dark:bg-amber-900/20 border-r-4 border-amber-500 rounded-lg';
            noteDiv.innerHTML = `<p class="text-amber-800 dark:text-amber-300 text-sm font-medium"><span>๐ก</span> ${item.text}</p>`;
            list.appendChild(noteDiv);
            return;
        }

        const isFav = isFavorite(unit.id.toString(), index);
        
        const card = document.createElement('div');
        card.id = `qa-card-${index}`;
        card.setAttribute('data-qa-index', index);
        card.className = `question-card qa-concept-card bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 mb-6 border-r-4 ${isFav ? 'border-purple-500' : 'border-blue-600'}`;
        
        card.innerHTML = `
            <div class="flex items-center justify-between mb-4 border-b pb-3 border-gray-100 dark:border-gray-700">
                <div class="flex items-center">
                    <div class="flex items-center justify-center w-7 h-7 rounded-full bg-blue-50 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 ml-2 flex-shrink-0 text-sm font-bold border-2 border-blue-600">
                        ${questionCounter++}
                    </div>
                    <h4 class="text-sm font-bold text-gray-900 dark:text-white leading-snug">${item.question}</h4>
                </div>
                <button class="favorite-btn p-1 ${isFav ? 'active' : ''}" 
                        data-unit-id="${unit.id}" 
                        data-question-index="${index}" 
                        title="${isFav ? 'ุฅุฒุงูุฉ ูู ุงูููุถูุฉ' : 'ุฅุถุงูุฉ ููููุถูุฉ'}">
                    ${isFav ? '<i class="fas fa-star text-purple-500"></i>' : '<i class="far fa-star"></i>'}
                </button>
            </div>`;

        const answerWrapper = document.createElement("div");
        answerWrapper.className = "mt-3 leading-relaxed text-gray-700 dark:text-gray-300";
        answerWrapper.appendChild(formatAnswerText(item.answer));
        card.appendChild(answerWrapper);

        if (item.page) {
            const pageRef = document.createElement("div");
            pageRef.className = "mt-4 pt-3 border-t border-gray-100 dark:border-gray-700 text-sm text-gray-500";
            pageRef.textContent = `ูุฑุฌุน ุงูุตูุญุฉ: ${item.page}`;
            card.appendChild(pageRef);
        }

        list.appendChild(card);
        applyKaTeX(card);
        
        const favoriteBtn = card.querySelector('.favorite-btn');
        if (favoriteBtn) {
            favoriteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const unitId = this.dataset.unitId;
                const questionIndex = parseInt(this.dataset.questionIndex);
                const wasAdded = toggleFavorite(unitId, questionIndex);
                card.classList.toggle('border-purple-500', wasAdded);
                card.classList.toggle('border-blue-600', !wasAdded);
                
                if (mode === 'favorites' && !wasAdded) {
                    setTimeout(() => {
                        showUnitQuestions(unit, 'favorites');
                    }, 300);
                }
                
                updateToggleFavoritesButton();
            });
        }
        
        displayedCount++;
    });

    if (typeof SearchManager !== 'undefined' && SearchManager.state.searchActive && SearchManager.state.currentSearchQuery) {
        // ุฅุฐุง ูุงู ุงูุจุญุซ ูุดุทุงูุ ูุง ูุณุชุฎุฏู ูุชุชุจุน ุงูุชูุฑูุฑ
        window.scrollTo({ top: 0, behavior: 'instant' });
    } else {
        if (appState.scrollObserver) {
            appState.scrollObserver.disconnect();
        }
        
        appState.scrollObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const idx = entry.target.getAttribute('data-qa-index');
                    localStorage.setItem(`last_stop_unit_${unit.id}`, idx);
                }
            });
        }, { threshold: 0.5 });

        document.querySelectorAll('.qa-concept-card').forEach(card => appState.scrollObserver.observe(card));

        const lastSavedIndex = localStorage.getItem(`last_stop_unit_${unit.id}`);
        if (lastSavedIndex !== null && mode !== 'favorites') {
            setTimeout(() => {
                const targetCard = document.getElementById(`qa-card-${lastSavedIndex}`);
                if (targetCard) {
                    const offset = 100;
                    window.scrollTo({
                        top: targetCard.offsetTop - offset,
                        behavior: 'smooth'
                    });
                    targetCard.classList.add('ring-2', 'ring-blue-500', 'ring-offset-2');
                    setTimeout(() => targetCard.classList.remove('ring-2', 'ring-blue-500'), 3000);
                }
            }, 300);
        } else if (mode === 'favorites' && displayedCount > 0) {
            setTimeout(() => {
                const firstCard = document.querySelector('.qa-concept-card');
                if (firstCard) {
                    const offset = 100;
                    window.scrollTo({
                        top: firstCard.offsetTop - offset,
                        behavior: 'smooth'
                    });
                }
            }, 300);
        } else {
            window.scrollTo({ top: 0, behavior: 'instant' });
        }
    }
    
    updateToggleFavoritesButton();
}

function renderExplanation(container, q, isCorrect, answeredIndices, type) {
    if (!container) return;
    
    container.innerHTML = '';
    const res = document.createElement('div');
    res.className = 'mt-3 pt-3 text-sm border-t border-gray-200 dark:border-gray-700';
    const feedback = document.createElement('div');
    feedback.className = "p-3 rounded-lg font-medium border ";
    
    let isIncomplete = false;
    if (type === 'mcq-multi' && !isCorrect && !appState.solutionsVisible) {
        const selected = Array.isArray(answeredIndices) ? answeredIndices : [];
        const hasAnyCorrect = selected.some(idx => q.answers.includes(idx));
        if (hasAnyCorrect) isIncomplete = true;
    }

    if (isCorrect) {
        feedback.className += "bg-green-50 border-green-200 text-green-700 dark:bg-green-900/40 dark:text-green-300";
        feedback.innerHTML = "โ ุฅุฌุงุจุฉ ุตุญูุญุฉ.";
    } else if (isIncomplete) {
        feedback.className += "bg-yellow-50 border-yellow-200 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-300";
        let correctText = q.answers.map(idx => `(${q.options[idx]})`).join(' ู ');
        feedback.innerHTML = `โ๏ธ ุฅุฌุงุจุฉ ุบูุฑ ูุงููุฉ - ุงููุงููุฉ ูู:  <br><small>${correctText}</small>`;
    } else {
        let correctText = type === 'mcq-multi' ? q.answers.map(idx => `(${q.options[idx]})`).join(' ู ') : q.options[q.answerIndex];
        feedback.className += "bg-red-50 border-red-200 text-red-700 dark:bg-red-900/40 dark:text-red-300";
        feedback.innerHTML = appState.solutionsVisible ? 
            `โ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ ูู: ${correctText}` : 
            `โ ุฅุฌุงุจุฉ ุฎุงุทุฆุฉ  โ ุงูุตุญูุญุฉ ูู: ${correctText}`;
    }
    
    res.appendChild(feedback);
    const expData = q.explanationSteps || q.explanation;
    
    if (Array.isArray(expData)) {
        const steps = document.createElement('div');
        steps.className = 'mt-4 explanation-steps space-y-3';
        expData.forEach((step, idx) => {
            const stepDiv = document.createElement('div');
            stepDiv.innerHTML = `<p class="font-bold mt-3 mb-1 flex items-center gap-2 text-sm"><span class="step-number">${idx+1}</span> ${step.title}</p><div class="${step.isResult ? 'text-lg font-extrabold text-primary' : 'mr-8'}">${step.isFormula ? `<div class="formula-box">${step.content}</div>` : step.content}</div>`;
            steps.appendChild(stepDiv);
        });
        res.appendChild(steps);
    } else if (expData) {
        const expDiv = document.createElement('div');
        expDiv.className = 'mt-3 text-sm text-gray-800 dark:text-gray-200';
        expDiv.innerHTML = ` ${expData}</p>`;
        res.appendChild(expDiv);
    }
    
    container.appendChild(res);
    applyKaTeX(container);
}

// ==========================================
// ุฏูุงู ุงููุณุงุนุฏุฉ ุงูุนุงูุฉ
// ==========================================
function calculateUnitProgress(unitId) {
    const unit = unitsData.find(u => u.id === unitId);
    if (!unit) return { answered:0, total:0, percent:0, accuracy:0, correct: 0, mistakes: 0, completion: 'not-started' };
    
    if (unit.type === 'qa-display') {
        const total = unit.questions.filter(q => !q.type || (q.type !== 'header' && q.type !== 'note')).length;
        return { answered:total, total:total, percent:100, accuracy:100, correct: total, mistakes: 0, completion: 'completed' };
    }
    
    const total = unit.questions.length;
    const answers = appState.userAnswers[unitId] || {};
    
    const answeredEntries = Object.values(answers).filter(a => a !== null);
    const answered = answeredEntries.length;
    const correct = answeredEntries.filter(a => a?.correct === true).length;
    const mistakes = answeredEntries.filter(a => a?.correct === false).length;
    
    const percent = total ? Math.round((answered / total) * 100) : 0;
    const accuracy = answered ? Math.round((correct / answered) * 100) : 0;
    let completionStatus = answered === 0 ? 'not-started' : (answered === total ? 'completed' : 'in-progress');
    
    return { answered, total, percent, accuracy, correct, mistakes, completion: completionStatus };
}

function updateUnitProgress() {
    if (!appState.currentUnit) return;
    
    const p = calculateUnitProgress(appState.currentUnit.id);
    const progressText = document.getElementById('unitProgressTop');
    const progressFill = document.getElementById('progressFillTop');
    const container = progressFill?.parentElement;

    if (appState.currentUnit.type === 'qa-display') {
        if (progressText) {
            progressText.innerHTML = '';
            progressText.style.display = 'none';
        }
        if (container) {
            container.style.opacity = '0';
            container.style.visibility = 'hidden';
        }
        return;
    }

    if (progressText) {
        progressText.style.display = 'flex';
        const accColor = p.accuracy >= 80 ? '#10b981' : (p.accuracy >= 50 ? '#f59e0b' : '#ef4444');
        progressText.innerHTML = `<div style="display:flex; gap:8px;"><b>ุงูุฅูุฌุงุฒ ${p.percent}%</b><span style="opacity:0.2;">|</span></span><span style="color:${accColor}"><small>ุงูุฏูุฉ:</small> ${p.accuracy}%</span></div>`;
    }
    
    if (container) {
        container.style.opacity = '1';
        container.style.visibility = 'visible';
    }
    
    if (progressFill) {
        progressFill.style.width = `${p.percent}%`;
        progressFill.style.background = p.accuracy >= 80 ? "linear-gradient(90deg, #10b981, #34d399)" : (p.accuracy >= 55 ? "linear-gradient(90deg, #f59e0b, #fbbf24)" : "linear-gradient(90deg, #ef4444, #f87171)");
    }
}

function updateOverallStats() {
    let totalQ = 0, totalCorrect = 0, totalIncorrect = 0;
    
    unitsData.forEach(unit => {
        if (unit.type === 'qa-display') return;
        totalQ += unit.questions.length;
        const answers = appState.userAnswers[unit.id] || {};
        Object.values(answers).forEach(a => { 
            if (a && a.correct === true) totalCorrect++; 
            else if (a && a.correct === false) totalIncorrect++; 
        });
    });
    
    const totalAnswered = totalCorrect + totalIncorrect;
    const successRate = totalAnswered ? Math.round((totalCorrect / totalAnswered) * 100) : 0;
    document.getElementById('totalQuestions').textContent = totalQ;
    document.getElementById('correctAnswers').textContent = totalCorrect;
    document.getElementById('incorrectAnswers').textContent = totalIncorrect;
    document.getElementById('successRate').textContent = successRate + '%';
}

function updateSolutionUI(isVisible) {
    const text = document.getElementById('solutionsTextInProgress');
    const container = document.getElementById('solutionIconContainer');
    const icon = document.getElementById('solutionIcon');
    
    if (!text || !icon || !container) return;

    if (isVisible) {
        text.textContent = "ุฅุฎูุงุก ุงูุญููู";
        icon.innerHTML = UI_ICONS.eyeHide;
        container.className = "p-1.5 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600";
    } else {
        text.textContent = "ุฅุธูุงุฑ ุงูุญููู";
        icon.innerHTML = UI_ICONS.eyeShow;
        container.className = "p-1.5 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600";
    }
}

function toggleAllSolutions() {
    if (!appState.currentUnit || appState.currentUnit.type === 'qa-display') return;
    appState.solutionsVisible = !appState.solutionsVisible;
    updateSolutionUI(appState.solutionsVisible);
    
    if (appState.solutionsVisible) {
        const correctAnswers = {};
        appState.currentUnit.filteredQuestions.forEach((q, i) => {
            const idx = q.originalIndex ?? i;
            if (appState.currentUnit.type === 'mcq-multi') {
                correctAnswers[idx] = { 
                    correct: true, 
                    selectedIndices: q.answers,
                    answerIndex: null,
                    wasCorrected: false
                };
            } else {
                correctAnswers[idx] = { 
                    answerIndex: q.answerIndex, 
                    correct: true,
                    wasCorrected: false
                };
            }
        });
        
        renderQuestions(appState.currentUnit.filteredQuestions, appState.currentUnit.type, correctAnswers);
    } else {
        renderQuestions(appState.currentUnit.filteredQuestions, appState.currentUnit.type);
    }
}

function hideAllSummaries() {
    ['practiceRoundSummary', 'quizCompletionSummary'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.classList.add('hidden', 'translate-y-full');
    });
}

function showCompletionToast(unitId) {
    const summaryBar = document.getElementById('quizCompletionSummary');
    if (!summaryBar || (appState.currentUnit && appState.currentUnit.mode === 'practice')) return;
    
    const stats = calculateUnitProgress(unitId);
    const isSuccess = stats.accuracy >= 70;
    
    document.getElementById('summaryQuizIcon').textContent = isSuccess ? '๐' : 'โ๏ธ';
    document.getElementById('summaryQuizTitle').querySelector('span:last-child').textContent = isSuccess ? 'ุชูุงูููุง ๐ ุชู ุฅููุงุก ุงูุงุฎุชุจุงุฑ ุจูุฌุงุญ' : 'ุชู ุฅููุงู ุงูุงุฎุชุจุงุฑ';
    document.getElementById('summaryTotalCount').textContent = stats.total;
    document.getElementById('summaryCorrectCount').textContent = stats.correct;
    document.getElementById('summaryWrongCount').textContent = stats.mistakes;
    
    document.getElementById('summaryAccuracy').textContent = stats.accuracy + '%';
    
    summaryBar.classList.remove('border-green-600', 'border-red-600', 'bg-green-50', 'bg-red-50');
    summaryBar.classList.add(isSuccess ? 'border-green-600' : 'border-red-600', isSuccess ? 'bg-green-50' : 'bg-red-50');
    
    const reviewBtn = document.getElementById('summaryReviewBtn');
    if (stats.mistakes > 0) {
        reviewBtn.classList.remove('hidden');
        reviewBtn.textContent = `ูุฑุงุฌุนุฉ ุงูุฃุฎุทุงุก (${stats.mistakes})`;
        reviewBtn.onclick = () => {
            hideAllSummaries();
            showUnitQuestions(appState.currentUnit, 'practice');
        };
    } else {
        reviewBtn.classList.add('hidden');
    }
    
    document.getElementById('summaryBackBtn').onclick = () => showUnitsView();
    summaryBar.classList.remove('hidden');
    
    setTimeout(() => {
        summaryBar.classList.remove('translate-y-full');
        summaryBar.classList.add('translate-y-0');
    }, 50);
}

function checkPracticeRoundStatus() {
    const totalInView = appState.currentUnit.filteredQuestions.length;
    const answeredInView = document.querySelectorAll('.question-card.question-answered').length;
    
    if (answeredInView >= totalInView && totalInView > 0) {
        let correct = 0, mistakes = 0;
        appState.currentUnit.filteredQuestions.forEach((q, i) => {
            const ans = appState.userAnswers[appState.currentUnit.id][q.originalIndex ?? i];
            if (ans?.correct) correct++;
            else mistakes++;
        });
        showPracticeRoundSummary(correct, mistakes);
    }
}

function showPracticeRoundSummary(correct, mistakes) {
    const bar = document.getElementById('practiceRoundSummary');
    document.getElementById('roundCorrectCount').textContent = correct;
    document.getElementById('roundWrongCount').textContent = mistakes;
    const btn = document.getElementById('nextRoundBtn');
    
    if (mistakes === 0) {
        btn.innerHTML = `<span>๐ ุฅููุงุก ุงููุฑุงุฌุนุฉ</span>`;
        btn.onclick = () => {
            bar.classList.add('translate-y-full', 'hidden');
            showUnitsView();
        };
    } else {
        btn.innerHTML = `<span>ูุฑุงุฌุนุฉ ุงูุฃุฎุทุงุก ุงููุชุจููุฉ (${mistakes}) ๐</span>`;
        btn.onclick = () => {
            hideAllSummaries();
            showUnitQuestions(appState.currentUnit, 'practice');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
    }
    
    bar.classList.remove('hidden');
    setTimeout(() => bar.classList.remove('translate-y-full'), 50);
}

function toggleFavoritesView() {
    if (!appState.currentUnit) return;
    
    const isCurrentlyInFavorites = appState.currentUnit.mode === 'favorites';
    
    if (isCurrentlyInFavorites) {
        showUnitQuestions(appState.currentUnit, 'normal');
    } else {
        const favCount = getFavoritesCount(appState.currentUnit.id.toString());
        if (favCount === 0) {
            showMessage('ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ููุถูุฉ ูู ูุฐู ุงููุญุฏุฉ ุจุนุฏ. ุงุถุบุท ุนูู ุฒุฑ ุงููุฌูุฉ โ ูู ุฃู ุณุคุงู ูุฅุถุงูุชู ููููุถูุฉ.', 'info');
            return;
        }
        showUnitQuestions(appState.currentUnit, 'favorites');
    }
}

function updateToggleFavoritesButton() {
    const favoritesIconContainer = document.getElementById('favoritesIconContainer');
    const favoritesToggleText = document.getElementById('favoritesToggleText');
    
    if (!favoritesIconContainer || !favoritesToggleText) return;
    
    const isInFavorites = appState.currentUnit && appState.currentUnit.mode === 'favorites';
    const favCount = appState.currentUnit ? getFavoritesCount(appState.currentUnit.id.toString()) : 0;
    
    if (isInFavorites) {
        favoritesToggleText.textContent = 'ุงูุนูุฏุฉ ูููุถุน ุงูุนุงุฏู';
        favoritesIconContainer.className = "p-1.5 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600";
    } else {
        favoritesToggleText.textContent = `ุนุฑุถ ุงูุฃุณุฆูุฉ ุงูููุถูุฉ (${favCount})`;
        favoritesIconContainer.className = "p-1.5 rounded-lg bg-yellow-100 dark:bg-yellow-900/30 text-yellow-600";
    }
}

function setActiveQuestion(qIndex, behavior = 'smooth') {
    const qId = `q-${qIndex}`;
    
    // ุฅุฒุงูุฉ ุงูุชุญุฏูุฏ ูู ุงูุจุทุงูุงุช ุงูุฃุฎุฑู
    document.querySelectorAll('.question-card').forEach(card => {
        card.classList.remove('active-question');
    });
    
    const targetElement = document.getElementById(qId);
    if (targetElement) {
        targetElement.classList.add('active-question');
        appState.activeQuestionIndex = qIndex;

        // ุชุญุฏูุซ ุงูุฅุทุงุฑุงุช (Frames) ููุณุคุงู ุงููุดุท
        const totalQuestions = appState.currentUnit.filteredQuestions ? appState.currentUnit.filteredQuestions.length : 0;
        for (let i = 0; i < totalQuestions; i++) {
            const isActive = (i === qIndex);
            const originalIndex = appState.currentUnit.filteredQuestions[i]?.originalIndex ?? i;
            const isFav = isFavorite(appState.currentUnit.id.toString(), originalIndex);
            updateQuestionFrame(i, null, false, isActive, isFav);
        }

        // 1. ุญุณุงุจ ุงุฑุชูุงุน ุงูุดุฑูุท ุงูุซุงุจุช
        const fixedBarHeight = document.getElementById('fixedTopBar').offsetHeight;
        
        // 2. ุงูุญุตูู ุนูู ูููุน ุงูุจุทุงูุฉ ุงููุนูู ุจุงููุณุจุฉ ูุตูุญุฉ ุงูุชูุฑูุฑ
        const bodyRect = document.body.getBoundingClientRect().top;
        const elementRect = targetElement.getBoundingClientRect().top;
        
        // 3. ุญุณุงุจ ุงููุณุงูุฉ ุงูุตุงููุฉ: (ูููุน ุงูุนูุตุฑ - ูููุน ุงูุฌุณู) - ุงุฑุชูุงุน ุงูุดุฑูุท - ูุงูุด ุจุณูุท
        const offsetPosition = (elementRect - bodyRect) - fixedBarHeight - 10;

        window.scrollTo({
            top: offsetPosition,
            behavior: behavior
        });
    }
}

function applyKaTeX(element) {
    if (!element || typeof renderMathInElement !== "function") return;

    renderMathInElement(element, {
        delimiters: [
            { left: "$$", right: "$$", display: true },
            { left: "\\[", right: "\\]", display: true },
            { left: "$", right: "$", display: false },
            { left: "\\(", right: "\\)", display: false }
        ],
        throwOnError: false
    });
}

function showResetConfirmation() {
    if (appState.currentUnit && confirm(`ูู ุชุฑูุฏ ุญุฐู ุฅุฌุงุจุงุชู ููุญุฏุฉ: ${appState.currentUnit.title}ุ`)) {
        delete appState.userAnswers[appState.currentUnit.id];
        saveStorageData();
        showUnitQuestions(appState.currentUnit, 'normal');
    }
}

function resetAllConfirmation() {
    if (confirm('ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุถุจุท ูู ุฅุฌุงุจุงุช ุฌููุน ุงููุญุฏุงุชุ')) {
        localStorage.removeItem(STORAGE_KEYS.ANSWERS);
        localStorage.removeItem(STORAGE_KEYS.FAVORITES);
        appState.userAnswers = {};
        appState.favorites = {};
        loadStorageData();
        showUnitsView();
        
        if (appState.firebaseUser) {
            syncDataToFirebase();
        }
    }
}

function updateQuestionsCounter(unit) {
    if (!unit) return;
    
    const totalQuestions = unit.questions.filter(q => !q.type || (q.type !== 'header' && q.type !== 'note')).length;
    const statsElement = document.getElementById('contentStats');
    const totalCountElement = document.getElementById('totalQuestionsCount');
    const lastUpdateElement = document.getElementById('lastUpdateTime');
    
    if (statsElement && totalCountElement && lastUpdateElement) {
        statsElement.classList.remove('hidden');
        totalCountElement.textContent = totalQuestions;
        lastUpdateElement.textContent = new Date().toLocaleTimeString('ar-SA', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }
}

window.autoExpandTextarea = function(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = (textarea.scrollHeight) + 'px';
};

window.deleteQuestion = async function(unit, index) {
    if (!checkAndUpdateUI()) {
        return;
    }
    
    if (!checkPermission('canDelete')) {
        showToast('ููุณ ูุฏูู ุตูุงุญูุฉ ูุญุฐู ุงูุฃุณุฆูุฉ', 'error');
        return;
    }
    
    if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุณุคุงูุ ุณูุชู ุญุฐูู ูุฌููุน ุงููุณุชุฎุฏููู.')) {
        const questionToDelete = { ...unit.questions[index] };
        const questions = [...unit.questions];
        questions.splice(index, 1);
        
        // ุญูุธ ูุณุฎุฉ ูู ุงููุญุชูู ุงููุญุฐูู
        if (typeof activityLogger !== 'undefined' && activityLogger.saveDeletedContent) {
            await activityLogger.saveDeletedContent(unit, questionToDelete, index);
        }
        
        updateUnitQuestions(unit.type, questions);
        
        // ุชุณุฌูู ุงููุดุงุท
        if (typeof activityLogger !== 'undefined' && activityLogger.logActivity) {
            await activityLogger.logActivity('DELETE', {
                unitId: unit.id,
                unitTitle: unit.title,
                questionIndex: index,
                questionText: questionToDelete.question || questionToDelete.text || '',
                oldData: questionToDelete
            });
        }
        
        const success = await saveQuestionsToFirebase();
        
        if (success) {
            showToast('ุชู ุญุฐู ุงูุณุคุงู ูุฌููุน ุงููุณุชุฎุฏููู', 'success');
        } else {
            showToast('ุชู ุญุฐู ุงูุณุคุงู ูุญููุงู ููุท', 'warning');
        }
        
        renderContentManagement(unit);
        updateOverallStats();
    }
};

// ==========================================
// ุชููุฆุฉ ุงูุชุทุจูู (ุชู ุชุญุฏูุซูุง)
// ==========================================
document.addEventListener('DOMContentLoaded', async () => {
    const savedTheme = localStorage.getItem(STORAGE_KEYS.THEME);
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    updateTheme(savedTheme === 'dark' || (!savedTheme && prefersDark));

    // ุชููุฆุฉ ูุธุงู ุงููุตุงุฏูุฉ (ููุฌูุฏ ุงูุขู ูู auth-manager.js)
    if (typeof initializeAuthSystem === 'function') {
        initializeAuthSystem();
    }

    loadStorageData();
    await loadQuestionsFromFirebase();
    
    // ุชููุฆุฉ ูุฏูุฑ ุงูุจุญุซ
    if (typeof SearchManager !== 'undefined') {
        SearchManager.initialize(appState);
    }
    
    showUnitsView(true);

    // ุงูุฃุฒุฑุงุฑ ุงูุฃุณุงุณูุฉ
    document.getElementById('backToUnitsTop')?.addEventListener('click', () => showUnitsView());
    document.getElementById('resetUnitTop')?.addEventListener('click', showResetConfirmation);
    document.getElementById('resetAllBtn')?.addEventListener('click', resetAllConfirmation);
    document.getElementById('toggleSolutionsBtn')?.addEventListener('click', toggleAllSolutions);
    document.getElementById('themeToggle')?.addEventListener('click', () => updateTheme(!document.documentElement.classList.contains('dark')));
    document.getElementById('themeToggleDropdown')?.addEventListener('click', () => updateTheme(!document.documentElement.classList.contains('dark')));
    document.getElementById('toggleFavoritesSmartDropdown')?.addEventListener('click', toggleFavoritesView);
    
    // ุฃุญุฏุงุซ Firebase
    document.getElementById('syncAllBtn')?.addEventListener('click', syncDataToFirebase);

    // ุงููุงุฆูุฉ ุงูููุณุฏูุฉ
    const menuBtn = document.getElementById('menuButton');
    const dropdown = document.getElementById('dropdownMenu');
    
    menuBtn?.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdown.classList.toggle('hidden');
    });
    
    document.addEventListener('click', () => dropdown?.classList.add('hidden'));

    // ุฒุฑ ุฅุถุงูุฉ ุณุคุงู ุฌุฏูุฏ
    document.getElementById('addNewQuestionBtn')?.addEventListener('click', () => {
        if (!checkAndUpdateUI()) {
            showLoginModal();
            return;
        }
        
        if (!checkPermission('canCreate')) {
            showToast('ููุณ ูุฏูู ุตูุงุญูุฉ ูุฅุถุงูุฉ ุฃุณุฆูุฉ', 'error');
            return;
        }
        
        if (appState.currentContentUnit) {
            contentManager.openModal(appState.currentContentUnit);
        }
    });

    // ุงูุชูููุน
    setTimeout(() => {
        const signature = document.getElementById("authorSignature");
        if (signature) {
            signature.classList.remove("opacity-0", "translate-y-8", "hidden");
        }
    }, 150);

    // ุงูุทุจุงุนุฉ
    document.getElementById('printQuestionsBtn')?.addEventListener('click', () => {
        window.print();
    });
    
    // ุชููุฆุฉ ุฃุญุฏุงุซ ุณุฌู ุงููุดุงุท ุฅุฐุง ูุงู ุงูููู ูุญููุงู
    if (typeof setupActivityLogEvents === 'function') {
        setupActivityLogEvents();
    }
});
        
        
</script>                          
</body>
</html>
